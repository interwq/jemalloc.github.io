<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> jemalloc Suitable for embedded environments
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jemalloc-discuss%40canonware.com?Subject=Re%3A%20jemalloc%20Suitable%20for%20embedded%20environments&In-Reply-To=%3CEDC505415B5EF74C80596BD24619C1032C382CD6%40xmb-rcd-x07.cisco.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001097.html">
   <LINK REL="Next"  HREF="001099.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>jemalloc Suitable for embedded environments</H1>
    <B>Mayank Kumar (mayankum)</B> 
    <A HREF="mailto:jemalloc-discuss%40canonware.com?Subject=Re%3A%20jemalloc%20Suitable%20for%20embedded%20environments&In-Reply-To=%3CEDC505415B5EF74C80596BD24619C1032C382CD6%40xmb-rcd-x07.cisco.com%3E"
       TITLE="jemalloc Suitable for embedded environments">mayankum at cisco.com
       </A><BR>
    <I>Thu May  7 16:01:04 PDT 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001097.html">jemalloc Suitable for embedded environments
</A></li>
        <LI>Next message: <A HREF="001099.html">jemalloc Suitable for embedded environments
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1098">[ date ]</a>
              <a href="thread.html#1098">[ thread ]</a>
              <a href="subject.html#1098">[ subject ]</a>
              <a href="author.html#1098">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Jason and Konstantin

Thanks for your replies. I will investigate along the pointers specified. Few more questions and comments:-

--what specifically causes the code size bloat ?
--it is comforting to hear that the jemalloc is already part of FreeBSD. I would like to know which version of jemalloc is part of FreeBSD releases now ? Also does the FreeBSD distribution of jemalloc includes all the enhancements done for Facebook or is it some stripped down version?

-mayank


-----Original Message-----
From: Jason Evans [mailto:<A HREF="http://www.canonware.com/mailman/listinfo/jemalloc-discuss">jasone at canonware.com</A>] 
Sent: Thursday, May 07, 2015 8:06 AM
To: Mayank Kumar (mayankum); Konstantin Tokarev
Cc: <A HREF="http://www.canonware.com/mailman/listinfo/jemalloc-discuss">jemalloc-discuss at canonware.com</A>
Subject: Re: jemalloc Suitable for embedded environments

On May 7, 2015, at 2:41 AM, Konstantin Tokarev &lt;<A HREF="http://www.canonware.com/mailman/listinfo/jemalloc-discuss">annulen at yandex.ru</A>&gt; wrote:
&gt;<i> 07.05.2015, 04:51, &quot;Mayank Kumar (mayankum)&quot; &lt;<A HREF="http://www.canonware.com/mailman/listinfo/jemalloc-discuss">mayankum at cisco.com</A>&gt;:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I recently started experimenting with jemalloc and found that jemalloc controls fragmentation phenomenally. A process that was running out of its allocated quota of 2g of virtual memory now uses only 1000mb of virtual memory and works without any crashes. I am trying to incorporate this library but it seems people have some apprehensions about it associated with big data applications(enhanced by facebook).
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Can someone answer the following question, while I am trying  to do some code reading:-
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 1.       Does jemalloc waste memory at the cost of speed and is optimized for big data applications ?
</I>
jemalloc remains the allocator built into FreeBSD's libc, and memory utilization has actually improved for such applications over the past five years, because I've taken care to solve performance issues in ways that scale both to large and small scale.  In my opinion the worst problem with jemalloc for very small embedded environments is code size, which translates to a larger instruction cache footprint.  Some features can be compiled out, but even so the resulting binary size is larger than that of most other allocators.

&gt;<i> By default jemalloc uses 4MiB chunks which can be too much for low memory systems. You might want to tune it with lg_chunk option (note that decreasing chunk size may affect performance).
</I>
The dev version now uses 256 KiB chunks, so this shouldn't be much of an issue starting with jemalloc 4.

&gt;&gt;<i> 2.       Are there scenarios where if many threads are competing for malloc, it will dynamically create new arenas to reduce  thread contention and are their parameters to control/tune them ?
</I>
The maximum number of arenas that can be automatically created is fixed at startup time, and can be tuned:

	<A HREF="http://www.canonware.com/download/jemalloc/jemalloc-latest/doc/jemalloc.html#opt.narenas">http://www.canonware.com/download/jemalloc/jemalloc-latest/doc/jemalloc.html#opt.narenas</A>

&gt;&gt;<i> 3.       Are there any other tunable parameters I should look at to ensure jemalloc doesn&#8217;t uncontrollably allocate memory in stress scenarios to optimize performance at the cost of memory . In my environment, I would expect jemalloc to reduce performance rather than allocate more  memory/arenas/pools to better performance.
</I>
You may want to turn off thread caches:

	<A HREF="http://www.canonware.com/download/jemalloc/jemalloc-latest/doc/jemalloc.html#opt.tcache">http://www.canonware.com/download/jemalloc/jemalloc-latest/doc/jemalloc.html#opt.tcache</A>

More aggressive dirty page purging may reduce physical memory usage, depending on application:

	<A HREF="http://www.canonware.com/download/jemalloc/jemalloc-latest/doc/jemalloc.html#opt.lg_dirty_mult">http://www.canonware.com/download/jemalloc/jemalloc-latest/doc/jemalloc.html#opt.lg_dirty_mult</A>

Jason
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001097.html">jemalloc Suitable for embedded environments
</A></li>
	<LI>Next message: <A HREF="001099.html">jemalloc Suitable for embedded environments
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1098">[ date ]</a>
              <a href="thread.html#1098">[ thread ]</a>
              <a href="subject.html#1098">[ subject ]</a>
              <a href="author.html#1098">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://www.canonware.com/mailman/listinfo/jemalloc-discuss">More information about the jemalloc-discuss
mailing list</a><br>
</body></html>
