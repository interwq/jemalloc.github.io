<tt>
&lt;div&nbsp;style=&quot;line-height:1.7;color:#000000;font-size:14px;font-family:Arial&quot;&gt;&lt;div&gt;Hi&nbsp;Jason,&nbsp;&lt;br&gt;&lt;br&gt;Thank&nbsp;you&nbsp;so&nbsp;much&nbsp;for&nbsp;the&nbsp;reply.&nbsp;I&nbsp;read&nbsp;the&nbsp;code&nbsp;once&nbsp;again,&nbsp;but&nbsp;I&nbsp;still&nbsp;don't&nbsp;understand&nbsp;the&nbsp;calculations&nbsp;here.&lt;br&gt;The&nbsp;original&nbsp;dirty&nbsp;chunk&nbsp;cmp&nbsp;function&nbsp;is,&lt;br&gt;&lt;br&gt;static&nbsp;inline&nbsp;int&lt;br&gt;arena_chunk_dirty_comp(arena_chunk_t&nbsp;*a,&nbsp;arena_chunk_t&nbsp;*b)&lt;br&gt;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;a_val&nbsp;=&nbsp;(a-&gt;nruns_avail&nbsp;-&nbsp;a-&gt;nruns_adjac)&nbsp;*&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b-&gt;nruns_avail;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;b_val&nbsp;=&nbsp;(b-&gt;nruns_avail&nbsp;-&nbsp;b-&gt;nruns_adjac)&nbsp;*&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a-&gt;nruns_avail;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(a_val&nbsp;&lt;&nbsp;b_val)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(1);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(a_val&nbsp;&gt;&nbsp;b_val)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(-1);&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......&lt;br&gt;}&lt;br&gt;&lt;br&gt;In&nbsp;the&nbsp;case&nbsp;as&nbsp;we&nbsp;mentioned&nbsp;above,&nbsp;how&nbsp;do&nbsp;you&nbsp;get&nbsp;a_val&nbsp;=&nbsp;0.45&nbsp;and&nbsp;b_val&nbsp;=&nbsp;1.5?&lt;br&gt;Is&nbsp;it&nbsp;because&nbsp;a_val&nbsp;=&nbsp;(10&nbsp;-&nbsp;1)&nbsp;/&nbsp;20;&nbsp;b_val&nbsp;=&nbsp;(20&nbsp;-&nbsp;5)&nbsp;/&nbsp;10?&lt;br&gt;But&nbsp;according&nbsp;to&nbsp;the&nbsp;code,&nbsp;a_val&nbsp;=&nbsp;(10&nbsp;-&nbsp;1)&nbsp;*&nbsp;20,&nbsp;and&nbsp;b_val&nbsp;=&nbsp;(20&nbsp;-&nbsp;5)&nbsp;*&nbsp;10,&nbsp;so&nbsp;it&nbsp;should&nbsp;return&nbsp;(-1)?&lt;br&gt;&lt;br&gt;And&nbsp;I&nbsp;trace&nbsp;the&nbsp;code&nbsp;in&nbsp;a&nbsp;demo,&nbsp;that&nbsp;makes&nbsp;me&nbsp;more&nbsp;confusing...&lt;br&gt;At&nbsp;first,&nbsp;I&nbsp;set&nbsp;the&nbsp;breakpoint&nbsp;at&nbsp;arena_chunk_dirty_first()&nbsp;when&nbsp;the&nbsp;Je&nbsp;is&nbsp;performing&nbsp;purging,&nbsp;and&nbsp;the&nbsp;backtrace&nbsp;is&nbsp;like&nbsp;this,&lt;br&gt;#0&nbsp;&nbsp;arena_chunk_dirty_first&nbsp;(rbtree=0x7ffff7010110)&nbsp;at&nbsp;src/arena.c:171&lt;br&gt;#1&nbsp;&nbsp;0x0000000000411f4e&nbsp;in&nbsp;arena_purge&nbsp;(arena=0x7ffff7010080,&nbsp;all=false)&nbsp;at&nbsp;src/arena.c:1032&lt;br&gt;#2&nbsp;&nbsp;0x0000000000411447&nbsp;in&nbsp;arena_maybe_purge&nbsp;(arena=0x7ffff7010080)&nbsp;at&nbsp;src/arena.c:793&lt;br&gt;#3&nbsp;&nbsp;0x000000000041299f&nbsp;in&nbsp;arena_run_dalloc&nbsp;(arena=0x7ffff7010080,&nbsp;run=0x7ffff68ce000,&nbsp;dirty=true,&nbsp;cleaned=false)&nbsp;at&nbsp;src/arena.c:1232&lt;br&gt;#4&nbsp;&nbsp;0x0000000000414db4&nbsp;in&nbsp;je_arena_dalloc_large_locked&nbsp;(arena=0x7ffff7010080,&nbsp;chunk=0x7ffff6800000,&nbsp;ptr=0x7ffff68ce000)&nbsp;at&nbsp;src/arena.c:1971&lt;br&gt;#5&nbsp;&nbsp;0x0000000000414df6&nbsp;in&nbsp;je_arena_dalloc_large&nbsp;(arena=0x7ffff7010080,&nbsp;chunk=0x7ffff6800000,&nbsp;ptr=0x7ffff68ce000)&nbsp;at&nbsp;src/arena.c:1979&lt;br&gt;#6&nbsp;&nbsp;0x0000000000409914&nbsp;in&nbsp;je_arena_dalloc&nbsp;(arena=0x7ffff7010080,&nbsp;chunk=0x7ffff6800000,&nbsp;ptr=0x7ffff68ce000,&nbsp;try_tcache=true)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;include/jemalloc/internal/arena.h:1056&lt;br&gt;#7&nbsp;&nbsp;0x0000000000401b85&nbsp;in&nbsp;je_idalloct&nbsp;(ptr=0x7ffff68ce000,&nbsp;try_tcache=true)&nbsp;at&nbsp;include/jemalloc/internal/jemalloc_internal.h:898&lt;br&gt;#8&nbsp;&nbsp;0x0000000000401c06&nbsp;in&nbsp;je_iqalloct&nbsp;(ptr=0x7ffff68ce000,&nbsp;try_tcache=true)&nbsp;at&nbsp;include/jemalloc/internal/jemalloc_internal.h:917&lt;br&gt;#9&nbsp;&nbsp;0x0000000000401c25&nbsp;in&nbsp;je_iqalloc&nbsp;(ptr=0x7ffff68ce000)&nbsp;at&nbsp;include/jemalloc/internal/jemalloc_internal.h:924&lt;br&gt;#10&nbsp;0x0000000000405414&nbsp;in&nbsp;ifree&nbsp;(ptr=0x7ffff68ce000)&nbsp;at&nbsp;src/jemalloc.c:1233&lt;br&gt;#11&nbsp;0x0000000000405a5c&nbsp;in&nbsp;xffree&nbsp;(ptr=0x7ffff68ce000)&nbsp;at&nbsp;src/jemalloc.c:1308&lt;br&gt;#12&nbsp;0x00000000004011f1&nbsp;in&nbsp;main&nbsp;(argc=1,&nbsp;argv=0x7fffffffe0c8)&nbsp;at&nbsp;main.c:40&lt;br&gt;&lt;br&gt;We&nbsp;can&nbsp;see&nbsp;the&nbsp;dirty&nbsp;chuck&nbsp;tree,&nbsp;&lt;br&gt;(gdb)&nbsp;p&nbsp;(arena_chunk_tree_t)&nbsp;*0x7ffff7010110&lt;br&gt;$16&nbsp;=&nbsp;{&lt;br&gt;&nbsp;&nbsp;rbt_root&nbsp;=&nbsp;0x7ffff6800000,&nbsp;&lt;br&gt;&nbsp;&nbsp;rbt_nil&nbsp;=&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;arena&nbsp;=&nbsp;0x0,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;dirty_link&nbsp;=&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rbn_left&nbsp;=&nbsp;0x7ffff7010118,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rbn_right_red&nbsp;=&nbsp;0x7ffff7010118&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;ndirty&nbsp;=&nbsp;0,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;nruns_avail&nbsp;=&nbsp;0,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;nruns_adjac&nbsp;=&nbsp;0,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;map&nbsp;=&nbsp;{{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}}&lt;br&gt;&nbsp;&nbsp;}&lt;br&gt;}&lt;br&gt;&lt;br&gt;The&nbsp;root&nbsp;node&nbsp;is&nbsp;0x7ffff6800000,&lt;br&gt;(gdb)&nbsp;p&nbsp;(arena_chunk_t)&nbsp;*0x7ffff6800000&lt;br&gt;$17&nbsp;=&nbsp;{&lt;br&gt;&nbsp;&nbsp;arena&nbsp;=&nbsp;0x7ffff7010080,&nbsp;&lt;br&gt;&nbsp;&nbsp;dirty_link&nbsp;=&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;rbn_left&nbsp;=&nbsp;0x7ffff6c00000,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;rbn_right_red&nbsp;=&nbsp;0x7ffff7010118&lt;br&gt;&nbsp;&nbsp;},&nbsp;&lt;br&gt;&nbsp;&nbsp;ndirty&nbsp;=&nbsp;96,&nbsp;&lt;br&gt;&nbsp;&nbsp;nruns_avail&nbsp;=&nbsp;3,&nbsp;&lt;br&gt;&nbsp;&nbsp;nruns_adjac&nbsp;=&nbsp;1,&nbsp;&lt;br&gt;&nbsp;&nbsp;map&nbsp;=&nbsp;{{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;}}&lt;br&gt;}&lt;br&gt;&lt;br&gt;And&nbsp;the&nbsp;left&nbsp;node&nbsp;is&nbsp;0x7ffff6c00000,&nbsp;which&nbsp;is&nbsp;also&nbsp;the&nbsp;left-most&nbsp;node(we&nbsp;only&nbsp;have&nbsp;two&nbsp;chunks&nbsp;here),&lt;br&gt;(gdb)&nbsp;p&nbsp;(arena_chunk_t)&nbsp;*0x7ffff6c00000&lt;br&gt;$18&nbsp;=&nbsp;{&lt;br&gt;&nbsp;&nbsp;arena&nbsp;=&nbsp;0x7ffff7010080,&nbsp;&lt;br&gt;&nbsp;&nbsp;dirty_link&nbsp;=&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;rbn_left&nbsp;=&nbsp;0x7ffff7010118,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;rbn_right_red&nbsp;=&nbsp;0x7ffff7010119&lt;br&gt;&nbsp;&nbsp;},&nbsp;&lt;br&gt;&nbsp;&nbsp;ndirty&nbsp;=&nbsp;72,&nbsp;&lt;br&gt;&nbsp;&nbsp;nruns_avail&nbsp;=&nbsp;127,&nbsp;&lt;br&gt;&nbsp;&nbsp;nruns_adjac&nbsp;=&nbsp;0,&nbsp;&lt;br&gt;&nbsp;&nbsp;map&nbsp;=&nbsp;{{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;}}&lt;br&gt;}&lt;br&gt;&lt;br&gt;So&nbsp;when&nbsp;returned&nbsp;from&nbsp;frame#0,&nbsp;we&nbsp;got&nbsp;the&nbsp;chunk&nbsp;0x7ffff6c00000,&lt;br&gt;(gdb)&nbsp;fin&lt;br&gt;Run&nbsp;till&nbsp;exit&nbsp;from&nbsp;#0&nbsp;&nbsp;arena_chunk_dirty_first&nbsp;(rbtree=0x7ffff7010110)&nbsp;at&nbsp;src/arena.c:171&lt;br&gt;0x0000000000411f4e&nbsp;in&nbsp;arena_purge&nbsp;(arena=0x7ffff7010080,&nbsp;all=false)&nbsp;at&nbsp;src/arena.c:1032&lt;br&gt;1032&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk&nbsp;=&nbsp;arena_chunk_dirty_first(&amp;arena-&gt;chunks_dirty);&lt;br&gt;Value&nbsp;returned&nbsp;is&nbsp;$19&nbsp;=&nbsp;(arena_chunk_t&nbsp;*)&nbsp;0x7ffff6c00000&lt;br&gt;&lt;br&gt;That&nbsp;is&nbsp;the&nbsp;traversal&nbsp;order,&nbsp;from&nbsp;0x7ffff6c00000&nbsp;-&gt;&nbsp;0x7ffff6800000.&nbsp;But&nbsp;you&nbsp;can&nbsp;see&nbsp;the&nbsp;&lt;br&gt;node&nbsp;0x7ffff6c00000&nbsp;with&nbsp;nruns_avail&nbsp;=&nbsp;127,&nbsp;nruns_adjac&nbsp;=&nbsp;0;&nbsp;and&nbsp;0x7ffff6800000&lt;br&gt;with&nbsp;nruns_avail&nbsp;=&nbsp;3,&nbsp;nruns_adjac&nbsp;=&nbsp;1.&nbsp;&nbsp;So&nbsp;why?&nbsp;According&nbsp;to&nbsp;the&nbsp;algorithm&nbsp;as&nbsp;you&nbsp;said,&lt;br&gt;shoultn't&nbsp;we&nbsp;purge&nbsp;0x7ffff6800000&nbsp;first?&nbsp;However&nbsp;actually&nbsp;we&nbsp;purged&nbsp;a&nbsp;chunk&nbsp;even&nbsp;with&nbsp;no&lt;br&gt;adjac&nbsp;first!&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;ÔÚ&nbsp;2016-01-12&nbsp;03:37:23£¬&quot;Jason&nbsp;Evans&quot;&nbsp;&lt;jasone@canonware.com&gt;&nbsp;Ð´µÀ£º&lt;br&gt;&nbsp;&lt;blockquote&nbsp;id=&quot;isReplyContent&quot;&nbsp;style=&quot;PADDING-LEFT:&nbsp;1ex;&nbsp;MARGIN:&nbsp;0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;&nbsp;BORDER-LEFT:&nbsp;#ccc&nbsp;1px&nbsp;solid&quot;&gt;On&nbsp;Jan&nbsp;7,&nbsp;2016,&nbsp;at&nbsp;6:46&nbsp;PM,&nbsp;mmzsmm&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:mmzsmm@163.com&quot;&nbsp;class=&quot;&quot;&gt;mmzsmm@163.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;style=&quot;line-height:&nbsp;1.7;&nbsp;font-size:&nbsp;14px;&nbsp;font-family:&nbsp;Arial;&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;[...]&nbsp;according&nbsp;to&nbsp;the&nbsp;code&nbsp;comments,&nbsp;the&nbsp;clean-dirty&nbsp;fragmentation&nbsp;is&nbsp;measured&nbsp;as,&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;*&nbsp;Order&nbsp;such&nbsp;that&nbsp;chunks&nbsp;with&nbsp;higher&nbsp;fragmentation&nbsp;are&nbsp;&quot;less&nbsp;than&quot;&lt;br&nbsp;class=&quot;&quot;&gt;*&nbsp;those&nbsp;with&nbsp;lower&nbsp;fragmentation&nbsp;--&nbsp;purging&nbsp;order&nbsp;is&nbsp;from&nbsp;&quot;least&quot;&nbsp;to&lt;br&nbsp;class=&quot;&quot;&gt;*&nbsp;&quot;greatest&quot;.&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;mean&nbsp;current&nbsp;avail&nbsp;run&nbsp;size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nruns_avail-nruns_adjac&lt;br&nbsp;class=&quot;&quot;&gt;--------------------------------------------&nbsp;&nbsp;=&nbsp;&nbsp;----------------------------------&lt;br&nbsp;class=&quot;&quot;&gt;mean&nbsp;defragmented&nbsp;avail&nbsp;run&nbsp;size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nruns_avail&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;So&nbsp;if&nbsp;I&nbsp;have&nbsp;a&nbsp;chunkA&nbsp;with&nbsp;avail_runs&nbsp;=&nbsp;10,&nbsp;adjac&nbsp;=&nbsp;1,&nbsp;and&nbsp;another&nbsp;chunkB&nbsp;with&nbsp;avail_runs&nbsp;=&nbsp;20,&nbsp;adjac&nbsp;=&nbsp;5.&lt;br&nbsp;class=&quot;&quot;&gt;Obviously,&nbsp;the&nbsp;fragmentA(0.9)&nbsp;&gt;&nbsp;fragmentB(0.75),&nbsp;so&nbsp;the&nbsp;A&nbsp;will&nbsp;be&nbsp;prior&nbsp;to&nbsp;B&nbsp;in&nbsp;the&nbsp;dirty&nbsp;chunk&nbsp;tree,&nbsp;and&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;will&nbsp;be&nbsp;purged&nbsp;first.&nbsp;But&nbsp;the&nbsp;chunkB&nbsp;truely&nbsp;has&nbsp;more&nbsp;adjacs&nbsp;than&nbsp;the&nbsp;A,&nbsp;and&nbsp;the&nbsp;performace&nbsp;gain&nbsp;after&nbsp;purging&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;chunkA&nbsp;is&nbsp;also&nbsp;less&nbsp;than&nbsp;the&nbsp;other(0.1&nbsp;vs&nbsp;0.25).&nbsp;Why&nbsp;we&nbsp;prefer&nbsp;to&nbsp;purge&nbsp;the&nbsp;chunk&nbsp;with&nbsp;&quot;less&nbsp;adjacs&quot;?&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;Shouldn't&nbsp;we&nbsp;purge&nbsp;more&nbsp;adjacs&nbsp;or&nbsp;clean-dirty&nbsp;fragments&nbsp;to&nbsp;acquire&nbsp;more&nbsp;continuous&nbsp;unalloc&nbsp;pages?&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;actually&nbsp;do&nbsp;purge&nbsp;B&nbsp;first,&nbsp;but&nbsp;it's&nbsp;hard&nbsp;to&nbsp;see&nbsp;unless&nbsp;you&nbsp;follow&nbsp;the&nbsp;calculations&nbsp;in&nbsp;the&nbsp;code.&nbsp;&nbsp;Note&nbsp;that&nbsp;a_val=0.45&nbsp;and&nbsp;b_val=1.5&nbsp;in&nbsp;this&nbsp;case,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;comparison&nbsp;function&nbsp;returns&nbsp;1,&nbsp;causing&nbsp;A&nbsp;to&nbsp;come&nbsp;after&nbsp;B&nbsp;in&nbsp;the&nbsp;in-order&nbsp;tree&nbsp;traversal.&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;style=&quot;line-height:&nbsp;1.7;&nbsp;font-size:&nbsp;14px;&nbsp;font-family:&nbsp;Arial;&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Another&nbsp;question&nbsp;is,&nbsp;I&nbsp;notice&nbsp;that&nbsp;before&nbsp;the&nbsp;git&nbsp;node&nbsp;e3d13060&nbsp;there&nbsp;are&nbsp;two&nbsp;avail-trees,&nbsp;one&nbsp;is&nbsp;for&nbsp;dirty,&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;and&nbsp;another&nbsp;for&nbsp;clean,&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;arena_avail_tree_t&nbsp;&nbsp;&nbsp;&nbsp;runs_avail_clean;&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;arena_avail_tree_t&nbsp;&nbsp;&nbsp;&nbsp;runs_avail_dirty;&lt;br&nbsp;class=&quot;&quot;&gt;After&nbsp;that,&nbsp;the&nbsp;two&nbsp;became&nbsp;one.&nbsp;So&nbsp;how&nbsp;to&nbsp;ensure&nbsp;the&nbsp;new&nbsp;runs&nbsp;allocaction&nbsp;to&nbsp;prefer&nbsp;to&nbsp;dirty&nbsp;pages?&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;IIRC,&nbsp;there&nbsp;were&nbsp;versions&nbsp;of&nbsp;jemalloc&nbsp;that&nbsp;did&nbsp;not&nbsp;prefer&nbsp;dirty&nbsp;pages.&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Note&nbsp;that&nbsp;you're&nbsp;looking&nbsp;at&nbsp;jemalloc&nbsp;3.x&nbsp;code,&nbsp;but&nbsp;4.x&nbsp;uses&nbsp;substantially&nbsp;different&nbsp;algorithms&nbsp;that&nbsp;obsoleted&nbsp;the&nbsp;code&nbsp;that&nbsp;ordered&nbsp;chunks&nbsp;according&nbsp;to&nbsp;fragmentation.&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Jason&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;span&nbsp;title=&quot;neteasefooter&quot;&gt;&lt;p&gt;&nbsp;&lt;/p&gt;&lt;/span&gt;
</tt>
