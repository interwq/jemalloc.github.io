<tt>
the&nbsp;huge&nbsp;realloc&nbsp;protocol&nbsp;is:&lt;div&gt;&lt;ol&gt;&lt;li&gt;allocate&nbsp;address&nbsp;space&nbsp;with&nbsp;mmap.&lt;/li&gt;&lt;li&gt;add&nbsp;the&nbsp;new&nbsp;space&nbsp;to&nbsp;the&nbsp;huge&nbsp;extent&nbsp;tree.&lt;/li&gt;&lt;li&gt;remap&nbsp;the&nbsp;old&nbsp;pages&nbsp;to&nbsp;the&nbsp;new&nbsp;address&nbsp;space&nbsp;with&nbsp;mremap.&nbsp; this&nbsp;avoid&nbsp;a&nbsp;copy.&lt;/li&gt;&lt;li&gt;remove&nbsp;the&nbsp;old&nbsp;address&nbsp;space&nbsp;from&nbsp;the&nbsp;huge&nbsp;extent&nbsp;tree.&lt;/li&gt;<br>
&lt;/ol&gt;&lt;div&gt;the&nbsp;problem&nbsp;occurs&nbsp;when&nbsp;the&nbsp;old&nbsp;address&nbsp;space&nbsp;becomes&nbsp;free&nbsp;during&nbsp;step&nbsp;3.&nbsp; another&nbsp;thread&nbsp;executing&nbsp;this&nbsp;protocol&nbsp;can&nbsp;get&nbsp;this&nbsp;address&nbsp;during&nbsp;the&nbsp;mmap&nbsp;in&nbsp;step&nbsp;1.&nbsp; then&nbsp;we&nbsp;have&nbsp;a&nbsp;race&nbsp;between&nbsp;the&nbsp;first&nbsp;thread&nbsp;removing&nbsp;the&nbsp;space&nbsp;in&nbsp;step&nbsp;4&nbsp;and&nbsp;the&nbsp;second&nbsp;thread&nbsp;adding&nbsp;the&nbsp;space&nbsp;in&nbsp;step&nbsp;2.&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;i&nbsp;switched&nbsp;the&nbsp;order&nbsp;of&nbsp;steps&nbsp;3&nbsp;and&nbsp;4&nbsp;to&nbsp;solve&nbsp;the&nbsp;problem&nbsp;in&nbsp;the&nbsp;huge_ralloc&nbsp;function.&nbsp; i&nbsp;moved&nbsp;the&nbsp;huge_dalloc&nbsp;call&nbsp;to&nbsp;before&nbsp;the&nbsp;mremap&nbsp;call.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
