<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;all,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;m&nbsp;writing&nbsp;a&nbsp;set&nbsp;of&nbsp;chunk_hooks&nbsp;that&nbsp;satisfy&nbsp;chunk_alloc&nbsp;requests&nbsp;with&nbsp;a&nbsp;bump&nbsp;pointer&nbsp;and&nbsp;opt&nbsp;out&nbsp;of&nbsp;dalloc,&nbsp;decommit,&nbsp;and&nbsp;purge.&nbsp;The&nbsp;goal&nbsp;is&nbsp;to&nbsp;back&nbsp;an&nbsp;arena&nbsp;with&nbsp;2MB&nbsp;and&nbsp;1GB&nbsp;huge&nbsp;pages&nbsp;on&nbsp;demand&nbsp;and&nbsp;force&nbsp;jemalloc&nbsp;to&nbsp;reuse&nbsp;the&nbsp;memory&nbsp;in&nbsp;that&nbsp;space.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;wrote&nbsp;a&nbsp;simple&nbsp;program&nbsp;to&nbsp;test&nbsp;page&nbsp;reuse.&nbsp;As&nbsp;pseudocode:&lt;/div&gt;&lt;div&gt;&lt;ol&gt;&lt;li&gt;malloc&nbsp;1GB&nbsp;of&nbsp;memory&nbsp;using&nbsp;repeated&nbsp;small&nbsp;allocations&lt;br&gt;&lt;/li&gt;&lt;li&gt;free&nbsp;that&nbsp;same&nbsp;1GB&lt;br&gt;&lt;/li&gt;&lt;li&gt;malloc&nbsp;a&nbsp;small&nbsp;amount&nbsp;of&nbsp;memory&nbsp;again&lt;br&gt;&lt;/li&gt;&lt;li&gt;check&nbsp;whether&nbsp;jemalloc&nbsp;call&nbsp;chunk_alloc&nbsp;again&nbsp;in&nbsp;(3)&lt;br&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;noticed&nbsp;that&nbsp;when&nbsp;dirty&nbsp;page&nbsp;purging&nbsp;is&nbsp;disabled&nbsp;by&nbsp;setting&nbsp;MALLOC_CONF=&quot;lg_dirty_mult:-1&quot;,&nbsp;jemalloc&nbsp;willingly&nbsp;reuses&nbsp;all&nbsp;of&nbsp;the&nbsp;memory&nbsp;provided&nbsp;by&nbsp;my&nbsp;chunk&nbsp;hooks,&nbsp;but&nbsp;when&nbsp;the&nbsp;option&nbsp;is&nbsp;off,&nbsp;it&nbsp;only&nbsp;reuses&nbsp;about&nbsp;one&nbsp;chunk&#39;s&nbsp;worth&nbsp;(~4Mb).&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;would&nbsp;consider&nbsp;this&nbsp;intended&nbsp;behavior&nbsp;(obviously&nbsp;my&nbsp;test&nbsp;program&nbsp;goes&nbsp;below&nbsp;the&nbsp;default&nbsp;8:1&nbsp;minimum&nbsp;active&nbsp;to&nbsp;free&nbsp;page&nbsp;ratio),&nbsp;except&nbsp;that&nbsp;the&nbsp;man&nbsp;page&nbsp;entry&nbsp;for&nbsp;chunk_purge_t&nbsp;reads&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;Â A&nbsp;chunk&nbsp;purge&nbsp;function&nbsp;conforms&nbsp;to&nbsp;the&nbsp;chunk_purge_t&nbsp;type&nbsp;and&nbsp;&lt;b&gt;optionally&lt;/b&gt;&nbsp;discards&nbsp;physical&nbsp;pages&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;m&nbsp;further&nbsp;confused&nbsp;because&nbsp;it&nbsp;seems&nbsp;that&nbsp;API&nbsp;for&nbsp;chunk_hooks_t&nbsp;offers&nbsp;no&nbsp;mechanism&nbsp;for&nbsp;signaling&nbsp;to&nbsp;jemalloc&nbsp;that&nbsp;the&nbsp;pages&nbsp;were&nbsp;not&nbsp;released.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Basically,&nbsp;I&#39;m&nbsp;asking&nbsp;whether&nbsp;it&#39;s&nbsp;intended&nbsp;that&nbsp;opt.lg_dirty_mult&nbsp;must&nbsp;be&nbsp;set&nbsp;to&nbsp;-1&nbsp;in&nbsp;order&nbsp;for&nbsp;jemalloc&nbsp;to&nbsp;reuse&nbsp;an&nbsp;arbitrary&nbsp;amount&nbsp;of&nbsp;chunk_hook-allocated&nbsp;memory.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Very&nbsp;best,&lt;/div&gt;&lt;div&gt;Benjamin&lt;/div&gt;&lt;/div&gt;<br>

</tt>
