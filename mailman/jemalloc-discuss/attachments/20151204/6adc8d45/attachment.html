<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;style=&quot;font-size:13px&quot;&gt;&lt;span&nbsp;style=&quot;font-size:small&quot;&gt;On&nbsp;Thu,&nbsp;Dec&nbsp;3,&nbsp;2015&nbsp;at&nbsp;8:35&nbsp;PM,&nbsp;Rogier&nbsp;&#39;DocWilco&#39;&nbsp;Mulhuijzen&nbsp;&lt;/span&gt;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:rogier+jemalloc@fastly.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rogier+jemalloc@fastly.com&lt;/a&gt;&gt;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:small&quot;&gt;&nbsp;wrote:&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Maybe&nbsp;I&#39;m&nbsp;saying&nbsp;something&nbsp;stupid,&nbsp;but&nbsp;isn&#39;t&nbsp;there&nbsp;a&nbsp;DALLOC&nbsp;on&nbsp;the&nbsp;second&nbsp;line&nbsp;of&nbsp;your&nbsp;output?&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:13px&quot;&gt;That&nbsp;output&nbsp;just&nbsp;states&nbsp;that&nbsp;dalloc&nbsp;was&nbsp;called.&nbsp;However,&nbsp;the&nbsp;dalloc&nbsp;chunk&nbsp;hook&nbsp;opts&nbsp;out&nbsp;of&nbsp;deallocation.&nbsp;So&nbsp;next&nbsp;jemalloc&nbsp;calls&nbsp;decommit,&nbsp;again&nbsp;with&nbsp;decommit&nbsp;opting&nbsp;out&nbsp;of&nbsp;decommitting&nbsp;the&nbsp;memory&nbsp;and&nbsp;so&nbsp;finally&nbsp;purge&nbsp;gets&nbsp;called,&nbsp;which&nbsp;one&nbsp;can&#39;t&nbsp;opt&nbsp;out&nbsp;from. &lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:13px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:13px&quot;&gt;If&nbsp;the&nbsp;memory&nbsp;was&nbsp;deallocated,&nbsp;only&nbsp;dalloc&nbsp;would&nbsp;have&nbsp;been&nbsp;called&nbsp;(no&nbsp;decommit&nbsp;or&nbsp;purge).&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:13px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:13px&quot;&gt;Best,&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:13px&quot;&gt;Jakob&lt;/span&gt; &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;On&nbsp;Thu,&nbsp;Dec&nbsp;3,&nbsp;2015&nbsp;at&nbsp;10:52&nbsp;AM&nbsp;Jakob&nbsp;Buchgraber&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:jakob.buchgraber@tum.de&quot;&nbsp;target=&quot;_blank&quot;&gt;jakob.buchgraber@tum.de&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hello&nbsp;Jason,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;playing&nbsp;around&nbsp;with&nbsp;the&nbsp;memory&nbsp;management&nbsp;hooks&nbsp;introduced&nbsp;in&nbsp;version&nbsp;4.&lt;/div&gt;&lt;div&gt;So&nbsp;I&nbsp;wrote&nbsp;a&nbsp;delegate&nbsp;for&nbsp;the&nbsp;default&nbsp;chunk&nbsp;hooks,&nbsp;that&nbsp;additionally&nbsp;report&nbsp;to&lt;/div&gt;&lt;div&gt;stdout&nbsp;what&#39;s&nbsp;happening&nbsp;[1]. &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;test&nbsp;program&nbsp;allocates&nbsp;1GB&nbsp;of&nbsp;memory&nbsp;and&nbsp;immediately&nbsp;frees&nbsp;it.&lt;/div&gt;&lt;div&gt;It&nbsp;then&nbsp;tries&nbsp;to&nbsp;allocate&nbsp;4MB&nbsp;and&nbsp;8MB.&nbsp;The&nbsp;output&nbsp;is&nbsp;as&nbsp;follows&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;ALLOC:&nbsp;new_addr&nbsp;0,&nbsp;size&nbsp;1073741824,&nbsp;alignment&nbsp;2097152,&nbsp;zero&nbsp;1,&nbsp;commit&nbsp;1,&nbsp;arena_ind&nbsp;0,&nbsp;ret&nbsp;0x7f2f52a00000&lt;/div&gt;&lt;div&gt;DALLOC:&nbsp;chunk&nbsp;0x7f2f52a00000,&nbsp;size&nbsp;1073741824,&nbsp;committed&nbsp;1,&nbsp;arena_ind&nbsp;0&lt;/div&gt;&lt;div&gt;DECOMMIT:&nbsp;chunk&nbsp;0x7f2f52a00000,&nbsp;size&nbsp;1073741824,&nbsp;offset&nbsp;0,&nbsp;length&nbsp;1073741824,&nbsp;arena_ind&nbsp;0&lt;/div&gt;&lt;div&gt;PURGE:&nbsp;chunk&nbsp;0x7f2f52a00000,&nbsp;size&nbsp;1073741824,&nbsp;offset&nbsp;0,&nbsp;length&nbsp;1073741824,&nbsp;arena_ind&nbsp;0&lt;/div&gt;&lt;div&gt;FREED&lt;/div&gt;&lt;div&gt;ALLOC:&nbsp;new_addr&nbsp;0,&nbsp;size&nbsp;4194304,&nbsp;alignment&nbsp;2097152,&nbsp;zero&nbsp;1,&nbsp;commit&nbsp;1,&nbsp;arena_ind&nbsp;0,&nbsp;ret&nbsp;0x7f2f52a00000&lt;/div&gt;&lt;div&gt;ALLOC:&nbsp;new_addr&nbsp;0,&nbsp;size&nbsp;8388608,&nbsp;alignment&nbsp;2097152,&nbsp;zero&nbsp;1,&nbsp;commit&nbsp;1,&nbsp;arena_ind&nbsp;0,&nbsp;ret&nbsp;0x7f2f52e00000&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Given&nbsp;that&nbsp;the&nbsp;1GB&nbsp;has&nbsp;not&nbsp;been&nbsp;deallocated,&nbsp;but&nbsp;purged&nbsp;I&nbsp;would&nbsp;expect &lt;/div&gt;&lt;div&gt;the&nbsp;last&nbsp;two&nbsp;ALLOCations&nbsp;not&nbsp;to&nbsp;have&nbsp;happened.&nbsp;Instead&nbsp;I&nbsp;would&nbsp;expect&lt;/div&gt;&lt;div&gt;the&nbsp;virtual&nbsp;memory&nbsp;from&nbsp;the&nbsp;1GB&nbsp;allocation&nbsp;before&nbsp;to&nbsp;be&nbsp;reused?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;running&nbsp;jemalloc&nbsp;4.0.4&nbsp;on&nbsp;Linux.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Also,&nbsp;on&nbsp;an&nbsp;unrelated&nbsp;note,&nbsp;is&nbsp;it&nbsp;generally&nbsp;safe&nbsp;to&nbsp;trigger&nbsp;purging&nbsp;for&nbsp;arena&nbsp;A&lt;/div&gt;&lt;div&gt;from&nbsp;within&nbsp;an&nbsp;allocation&nbsp;chunk&nbsp;hook&nbsp;of&nbsp;arena&nbsp;B,&nbsp;with&nbsp;A&nbsp;&lt;&gt;&nbsp;B? &lt;/div&gt;&lt;div&gt;The&nbsp;reason&nbsp;why&nbsp;am&nbsp;asking&nbsp;this&nbsp;question&nbsp;is&nbsp;that&nbsp;I&nbsp;would&nbsp;generally&nbsp;want&nbsp;to &lt;/div&gt;&lt;div&gt;run&nbsp;with&nbsp;purging&nbsp;disabled&nbsp;on&nbsp;all&nbsp;arenas,&nbsp;but&nbsp;if&nbsp;some&nbsp;threshold&nbsp;of&nbsp;committed &lt;/div&gt;&lt;div&gt;memory&nbsp;is&nbsp;surpassed&nbsp;I&nbsp;would&nbsp;like&nbsp;to&nbsp;enable&nbsp;purging&nbsp;for&nbsp;some&nbsp;arenas. &lt;/div&gt;&lt;div&gt;Does&nbsp;this&nbsp;sound&nbsp;feasible?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;Jakob&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;[1]&nbsp;&lt;a&nbsp;href=&quot;https://gist.github.com/buchgr/243b0aa9a2abeda2ac39&quot;&nbsp;target=&quot;_blank&quot;&gt;https://gist.github.com/buchgr/243b0aa9a2abeda2ac39&lt;/a&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
_______________________________________________&lt;br&gt;<br>
jemalloc-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:jemalloc-discuss@canonware.com&quot;&nbsp;target=&quot;_blank&quot;&gt;jemalloc-discuss@canonware.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://www.canonware.com/mailman/listinfo/jemalloc-discuss&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.canonware.com/mailman/listinfo/jemalloc-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;Mit&nbsp;freundlichen&nbsp;Grüßen&nbsp;/&nbsp;Best&nbsp;Regards&lt;div&gt;Jakob&nbsp;Buchgraber&lt;/div&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
