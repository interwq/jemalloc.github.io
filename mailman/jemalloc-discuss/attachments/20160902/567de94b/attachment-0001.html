<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;30&nbsp;Aug&nbsp;2016,&nbsp;at&nbsp;22:43,&nbsp;Paul&nbsp;Smith&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:paul@mad-scientist.net&quot;&nbsp;class=&quot;&quot;&gt;paul@mad-scientist.net&lt;/a&gt;&gt;&nbsp;wrote:&lt;/div&gt;<br>
&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;Hi&nbsp;all.&nbsp;&nbsp;I&nbsp;wonder&nbsp;if&nbsp;anyone&nbsp;has&nbsp;any&nbsp;thoughts&nbsp;for&nbsp;me&nbsp;about&nbsp;a&nbsp;situation&nbsp;I&lt;br&nbsp;class=&quot;&quot;&gt;<br>
have.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
I'm&nbsp;working&nbsp;on&nbsp;GNU/Linux.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
I'm&nbsp;compiling&nbsp;jemalloc&nbsp;as&nbsp;a&nbsp;static&nbsp;library&nbsp;(with&nbsp;-fPIC)&nbsp;then&nbsp;I&nbsp;link&nbsp;it&lt;br&nbsp;class=&quot;&quot;&gt;<br>
into&nbsp;my&nbsp;own&nbsp;shared&nbsp;library&nbsp;(.so).&nbsp;&nbsp;I&nbsp;use&nbsp;-fvisibility=hidden&nbsp;so&nbsp;that&lt;br&nbsp;class=&quot;&quot;&gt;<br>
the&nbsp;jemalloc&nbsp;symbols&nbsp;are&nbsp;not&nbsp;visible&nbsp;outside&nbsp;the&nbsp;shared&nbsp;library&nbsp;(e.g.,&lt;br&nbsp;class=&quot;&quot;&gt;<br>
when&nbsp;I&nbsp;use&nbsp;&quot;nm&quot;&nbsp;on&nbsp;my&nbsp;.so,&nbsp;all&nbsp;the&nbsp;jemalloc&nbsp;symbols&nbsp;are&nbsp;marked&nbsp;&quot;t&quot;&nbsp;not&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&quot;T&quot;).&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
It&nbsp;works&nbsp;all&nbsp;the&nbsp;time&nbsp;for&nbsp;my&nbsp;testing&nbsp;and&nbsp;most&nbsp;of&nbsp;the&nbsp;time&nbsp;for&nbsp;my&nbsp;users.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
However,&nbsp;in&nbsp;some&nbsp;situations&nbsp;I've&nbsp;had&nbsp;users&nbsp;report&nbsp;that&nbsp;their&nbsp;process&nbsp;is&lt;br&nbsp;class=&quot;&quot;&gt;<br>
hanging&nbsp;and&nbsp;when&nbsp;I&nbsp;get&nbsp;a&nbsp;stacktrace,&nbsp;the&nbsp;hang&nbsp;is&nbsp;happening&nbsp;inside&lt;br&nbsp;class=&quot;&quot;&gt;<br>
pthread_mutex_unlock&nbsp;called&nbsp;from&nbsp;within&nbsp;jemalloc&nbsp;tls&nbsp;stuff.&nbsp;&nbsp;Note&nbsp;that&lt;br&nbsp;class=&quot;&quot;&gt;<br>
my&nbsp;library&nbsp;is&nbsp;not&nbsp;being&nbsp;linked&nbsp;directly,&nbsp;it's&nbsp;being&nbsp;dlopen()'d,&nbsp;so&nbsp;the&lt;br&nbsp;class=&quot;&quot;&gt;<br>
process&nbsp;is&nbsp;running&nbsp;for&nbsp;a&nbsp;bit&nbsp;before&nbsp;my&nbsp;library&nbsp;is&nbsp;loaded.&nbsp;&nbsp;To&nbsp;be&lt;br&nbsp;class=&quot;&quot;&gt;<br>
precise,&nbsp;it's&nbsp;being&nbsp;loaded&nbsp;inside&nbsp;an&nbsp;openjdk&nbsp;1.8&nbsp;JVM&nbsp;and&nbsp;invoked&nbsp;from&lt;br&nbsp;class=&quot;&quot;&gt;<br>
Java&nbsp;using&nbsp;JNI.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
Here's&nbsp;a&nbsp;sample&nbsp;stacktrace:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
#0&nbsp;&nbsp;0x0000003793a0a8a9&nbsp;in&nbsp;pthread_mutex_unlock&nbsp;()&nbsp;from&nbsp;./lib64/libpthread.so.0&lt;br&nbsp;class=&quot;&quot;&gt;<br>
#1&nbsp;&nbsp;0x00000037932110d2&nbsp;in&nbsp;tls_get_addr_tail&nbsp;()&nbsp;from&nbsp;./lib64/ld-linux-x86-64.so.2&lt;br&nbsp;class=&quot;&quot;&gt;<br>
#2&nbsp;&nbsp;0x0000003793211500&nbsp;in&nbsp;__tls_get_addr&nbsp;()&nbsp;from&nbsp;./lib64/ld-linux-x86-64.so.2&lt;br&nbsp;class=&quot;&quot;&gt;<br>
#3&nbsp;&nbsp;0x00007f0181a7ab7f&nbsp;in&nbsp;tcache_enabled_get&nbsp;()&nbsp;at&nbsp;jemalloc/include/jemalloc/internal/tcache.h:172&lt;br&nbsp;class=&quot;&quot;&gt;<br>
#4&nbsp;&nbsp;tcache_get&nbsp;(create=true)&nbsp;at&nbsp;jemalloc/include/jemalloc/internal/tcache.h:238&lt;br&nbsp;class=&quot;&quot;&gt;<br>
#5&nbsp;&nbsp;arena_malloc&nbsp;(arena=0x0,&nbsp;zero=false,&nbsp;try_tcache=true,&nbsp;size=96)&nbsp;at&nbsp;jemalloc/include/jemalloc/internal/arena.h:873&lt;br&nbsp;class=&quot;&quot;&gt;<br>
#6&nbsp;&nbsp;imallocx&nbsp;(try_tcache=true,&nbsp;arena=0x0,&nbsp;size=96)&nbsp;at&nbsp;jemalloc/include/jemalloc/internal/jemalloc_internal.h:767&lt;br&nbsp;class=&quot;&quot;&gt;<br>
#7&nbsp;&nbsp;imalloc&nbsp;(size=96)&nbsp;at&nbsp;jemalloc/include/jemalloc/internal/jemalloc_internal.h:776&lt;br&nbsp;class=&quot;&quot;&gt;<br>
#8&nbsp;&nbsp;prof_tdata_init&nbsp;()&nbsp;at&nbsp;jemalloc/src/prof.c:1244&lt;br&nbsp;class=&quot;&quot;&gt;<br>
#9&nbsp;&nbsp;0x00007f0181a5f7dd&nbsp;in&nbsp;prof_tdata_get&nbsp;()&nbsp;at&nbsp;jemalloc/include/jemalloc/internal/prof.h:317&lt;br&nbsp;class=&quot;&quot;&gt;<br>
#10&nbsp;malloc&nbsp;(size=&lt;optimized&nbsp;out&gt;)&nbsp;at&nbsp;jemalloc/src/jemalloc.c:850&lt;br&nbsp;class=&quot;&quot;&gt;<br>
#11&nbsp;0x00007f018185fbb1&nbsp;in&nbsp;operator&nbsp;new&nbsp;[]&nbsp;(size=19)&nbsp;at&nbsp;core/Allocator.h:86&lt;br&nbsp;class=&quot;&quot;&gt;<br>
#12&nbsp;String::allocate&nbsp;(this=this@entry=0x7f0189c93e40,&nbsp;length=length@entry=6)&nbsp;at&nbsp;core/StringClass.cpp:158&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;...&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
(I&nbsp;should&nbsp;come&nbsp;clean&nbsp;and&nbsp;mention&nbsp;this&nbsp;is&nbsp;an&nbsp;older&nbsp;version&nbsp;of&nbsp;jemalloc:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
3.1&nbsp;I&nbsp;believe--if&nbsp;that's&nbsp;likely&nbsp;to&nbsp;be&nbsp;the&nbsp;issue&nbsp;I&nbsp;can&nbsp;look&nbsp;into&lt;br&nbsp;class=&quot;&quot;&gt;<br>
updating).&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/blockquote&gt;<br>
&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;Menlo-Regular;&nbsp;font-size:&nbsp;11px;&quot;&nbsp;class=&quot;&quot;&gt;3.1&nbsp;is&nbsp;pretty&nbsp;old&nbsp;now.&nbsp;&nbsp;A&nbsp;quick&nbsp;scan&nbsp;through&nbsp;the&nbsp;ChangeLog&nbsp;does&nbsp;suggest&nbsp;there’s&nbsp;been&nbsp;a&nbsp;few&nbsp;changes&nbsp;related&nbsp;to&nbsp;TLS&nbsp;initialisation&nbsp;/&nbsp;bootstrap.&nbsp;I’d&nbsp;be&nbsp;tempted&nbsp;to&nbsp;at&nbsp;least&nbsp;upgrade&nbsp;to&nbsp;the&nbsp;most<br>
&nbsp;recent&nbsp;3.x,&nbsp;and&nbsp;maybe&nbsp;even&nbsp;4.1.x&nbsp;and&nbsp;see&nbsp;if&nbsp;the&nbsp;problem&nbsp;goes&nbsp;away.&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;Menlo-Regular&quot;&nbsp;class=&quot;&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11px;&quot;&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/span&gt;&lt;/font&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
The&nbsp;hang&nbsp;seems&nbsp;to&nbsp;happen&nbsp;very&nbsp;close&nbsp;to&nbsp;when&nbsp;this&nbsp;library&nbsp;starts,&nbsp;and&lt;br&nbsp;class=&quot;&quot;&gt;<br>
it's&nbsp;clearly&nbsp;in&nbsp;a&nbsp;fundamental&nbsp;area.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
What&nbsp;I&nbsp;was&nbsp;wondering&nbsp;was&nbsp;whether&nbsp;it&nbsp;might&nbsp;be&nbsp;possible&nbsp;that&nbsp;some&nbsp;static&lt;br&nbsp;class=&quot;&quot;&gt;<br>
memory&nbsp;inside&nbsp;jemalloc&nbsp;was&nbsp;not&nbsp;getting&nbsp;initialized&nbsp;in&nbsp;the&nbsp;right&nbsp;order&lt;br&nbsp;class=&quot;&quot;&gt;<br>
when&nbsp;the&nbsp;shared&nbsp;library&nbsp;is&nbsp;loaded.&nbsp;&nbsp;Perhaps&nbsp;there's&nbsp;some&nbsp;other&nbsp;static&lt;br&nbsp;class=&quot;&quot;&gt;<br>
variable&nbsp;with&nbsp;a&nbsp;constructor&nbsp;which&nbsp;allocates&nbsp;memory,&nbsp;and&nbsp;if&nbsp;they&nbsp;are&lt;br&nbsp;class=&quot;&quot;&gt;<br>
invoked&nbsp;in&nbsp;the&nbsp;wrong&nbsp;order&nbsp;then&nbsp;jemalloc's&nbsp;structures&nbsp;are&nbsp;not&nbsp;set&nbsp;up&lt;br&nbsp;class=&quot;&quot;&gt;<br>
properly&nbsp;or&nbsp;something.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
Does&nbsp;this&nbsp;seem&nbsp;like&nbsp;it&nbsp;might&nbsp;be&nbsp;plausible?&nbsp;&nbsp;If&nbsp;so&nbsp;is&nbsp;there&nbsp;anything&lt;br&nbsp;class=&quot;&quot;&gt;<br>
that&nbsp;can&nbsp;be&nbsp;done&nbsp;(other&nbsp;than&nbsp;sweeping&nbsp;all&nbsp;my&nbsp;code&nbsp;to&nbsp;remove&nbsp;any&lt;br&nbsp;class=&quot;&quot;&gt;<br>
allocation&nbsp;done&nbsp;during&nbsp;a&nbsp;static&nbsp;constructor)?&nbsp;&nbsp;It's&nbsp;OK&nbsp;if&nbsp;this&nbsp;is&nbsp;a&lt;br&nbsp;class=&quot;&quot;&gt;<br>
GCC-only&nbsp;solution,&nbsp;such&nbsp;as&nbsp;using&nbsp;__attribute__((init_priority()))&nbsp;or&lt;br&nbsp;class=&quot;&quot;&gt;<br>
something...&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
It&nbsp;would&nbsp;be&nbsp;much&nbsp;simpler&nbsp;if&nbsp;I&nbsp;could&nbsp;reproduce&nbsp;the&nbsp;problem&nbsp;myself,&nbsp;then&lt;br&nbsp;class=&quot;&quot;&gt;<br>
I&nbsp;could&nbsp;just&nbsp;experiment,&nbsp;but&nbsp;so&nbsp;far&nbsp;no&nbsp;luck.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
_______________________________________________&lt;br&nbsp;class=&quot;&quot;&gt;<br>
jemalloc-discuss&nbsp;mailing&nbsp;list&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;a&nbsp;href=&quot;mailto:jemalloc-discuss@canonware.com&quot;&nbsp;class=&quot;&quot;&gt;jemalloc-discuss@canonware.com&lt;/a&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
http://www.canonware.com/mailman/listinfo/jemalloc-discuss&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/blockquote&gt;<br>
&lt;/div&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
