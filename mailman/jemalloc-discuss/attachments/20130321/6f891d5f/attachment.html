<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;div&gt;&lt;div&gt;On&nbsp;Mar&nbsp;21,&nbsp;2013,&nbsp;at&nbsp;7:21&nbsp;AM,&nbsp;Benjamin&nbsp;Bazso&nbsp;wrote:&lt;/div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;I&nbsp;am&nbsp;using&nbsp;jemalloc&nbsp;for&nbsp;my&nbsp;server&nbsp;application&nbsp;and&nbsp;I&nbsp;have&nbsp;been&nbsp;monitoring&nbsp;the&nbsp;memory&nbsp;(rss)&nbsp;for&nbsp;several&nbsp;days&nbsp;and&nbsp;it&nbsp;continues&nbsp;to&nbsp;rise.&nbsp;&nbsp;I&nbsp;have&nbsp;previously&nbsp;monitored&nbsp;the&nbsp;application&nbsp;using&nbsp;valgrind&nbsp;for&nbsp;several&nbsp;days&nbsp;and&nbsp;it&nbsp;reported&nbsp;no&nbsp;memory&nbsp;leaks.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;version&nbsp;of&nbsp;jemalloc&nbsp;are&nbsp;you&nbsp;using,&nbsp;and&nbsp;on&nbsp;what&nbsp;operating&nbsp;system?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Also,&nbsp;valgrind&nbsp;will&nbsp;report&nbsp;as&nbsp;leaks&nbsp;memory&nbsp;that&nbsp;is&nbsp;unreachable,&nbsp;but&nbsp;your&nbsp;application&nbsp;can&nbsp;bloat&nbsp;its&nbsp;reachable&nbsp;memory&nbsp;usage&nbsp;without&nbsp;valgrind&nbsp;complaining.&nbsp;&nbsp;You&nbsp;may&nbsp;find&nbsp;jemalloc's&nbsp;heap&nbsp;profiling&nbsp;support&nbsp;useful&nbsp;in&nbsp;understanding&nbsp;where&nbsp;your&nbsp;application&nbsp;is&nbsp;actually&nbsp;using&nbsp;memory,&nbsp;and&nbsp;if&nbsp;allocated&nbsp;memory&nbsp;usage&nbsp;is&nbsp;truly&nbsp;growing,&nbsp;you&nbsp;will&nbsp;be&nbsp;able&nbsp;to&nbsp;tell&nbsp;where&nbsp;that&nbsp;growth&nbsp;is&nbsp;occurring&nbsp;within&nbsp;your&nbsp;application.&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
This&nbsp;leads&nbsp;me&nbsp;to&nbsp;believe&nbsp;that&nbsp;the&nbsp;rise&nbsp;in&nbsp;memory&nbsp;consumption&nbsp;(rss)&nbsp;is&nbsp;due&nbsp;to&nbsp;memory&nbsp;fragmentation.&lt;br&gt;&lt;br&gt;With&nbsp;this&nbsp;in&nbsp;mind,&nbsp;I&nbsp;added&nbsp;to&nbsp;my&nbsp;application&nbsp;the&nbsp;call&nbsp;to&nbsp;&lt;code&nbsp;class=&quot;function&quot;&gt;malloc_stats_print&lt;/code&gt;(&lt;em&nbsp;class=&quot;parameter&quot;&gt;&lt;code&gt;&lt;/code&gt;&lt;/em&gt;)&nbsp;function&nbsp;and&nbsp;I&nbsp;poll&nbsp;this&nbsp;function&nbsp;every&nbsp;hour&nbsp;and&nbsp;save&nbsp;the&nbsp;results.&nbsp;&nbsp;From&nbsp;what&nbsp;I&nbsp;see&nbsp;and&nbsp;understand&nbsp;from&nbsp;this&nbsp;report,&nbsp;I&nbsp;do&nbsp;indeed&nbsp;see&nbsp;the&nbsp;memory&nbsp;consumption&nbsp;rising&nbsp;and&nbsp;I&nbsp;also&nbsp;noticed&nbsp;that&nbsp;the&nbsp;number&nbsp;of&nbsp;bigger&nbsp;allocations&nbsp;increases&nbsp;(~2.5&nbsp;MB)&nbsp;over&nbsp;time.&lt;br&gt;<br>
&lt;br&gt;[...]&lt;br&gt;&lt;ol&gt;&lt;li&gt;How&nbsp;can&nbsp;I&nbsp;use&nbsp;the&nbsp;&lt;code&nbsp;class=&quot;function&quot;&gt;malloc_stats_print&lt;/code&gt;(&lt;em&nbsp;class=&quot;parameter&quot;&gt;&lt;code&gt;&lt;/code&gt;&lt;/em&gt;)&nbsp;stats&nbsp;to&nbsp;show&nbsp;that&nbsp;my&nbsp;application&nbsp;is&nbsp;suffering&nbsp;from&nbsp;memory&nbsp;fragmentation?&lt;/li&gt;&lt;/ol&gt;&lt;/blockquote&gt;&lt;div&gt;For&nbsp;a&nbsp;summary&nbsp;of&nbsp;external&nbsp;fragmentation,&nbsp;look&nbsp;for&nbsp;the&nbsp;line&nbsp;that&nbsp;looks&nbsp;like:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Allocated:&nbsp;5352608,&nbsp;active:&nbsp;5353472,&nbsp;mapped:&nbsp;285212672&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;External&nbsp;fragmentation&nbsp;can&nbsp;be&nbsp;computed&nbsp;as&nbsp;1.0&nbsp;-&nbsp;(allocated/active).&nbsp;&nbsp;That&nbsp;doesn't&nbsp;tell&nbsp;the&nbsp;whole&nbsp;RSS&nbsp;picture&nbsp;though;&nbsp;there&nbsp;are&nbsp;internal&nbsp;jemalloc&nbsp;data&nbsp;structures,&nbsp;dirty&nbsp;unused&nbsp;pages,&nbsp;and&nbsp;thread-cached&nbsp;objects&nbsp;that&nbsp;impose&nbsp;additional&nbsp;overhead.&lt;/div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;ol&nbsp;start=&quot;2&quot;&gt;&lt;li&gt;Is&nbsp;there&nbsp;a&nbsp;way&nbsp;to&nbsp;help&nbsp;eliminate&nbsp;fragmentation&nbsp;in&nbsp;jemalloc,&nbsp;perhaps&nbsp;by&nbsp;calling&nbsp;an&nbsp;extended&nbsp;facility?&lt;br&gt;<br>
&lt;/li&gt;&lt;/ol&gt;&lt;/blockquote&gt;jemalloc&nbsp;would&nbsp;need&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;compact&nbsp;active&nbsp;allocations&nbsp;via&nbsp;relocation&nbsp;in&nbsp;order&nbsp;to&nbsp;eliminate&nbsp;fragmentation,&nbsp;and&nbsp;that's&nbsp;simply&nbsp;not&nbsp;generally&nbsp;possible&nbsp;in&nbsp;C/C++.&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;ol&nbsp;start=&quot;3&quot;&gt;&lt;li&gt;Will&nbsp;using&nbsp;thread&nbsp;cache&nbsp;flushing&nbsp;and&nbsp;forced&nbsp;dirty&nbsp;page&nbsp;purging&nbsp;help&nbsp;reduce&nbsp;fragmentation?&nbsp;Is&nbsp;it&nbsp;a&nbsp;good&nbsp;idea?&lt;/li&gt;&lt;/ol&gt;&lt;/blockquote&gt;&lt;/div&gt;Yes,&nbsp;this&nbsp;may&nbsp;reduce&nbsp;fragmentation,&nbsp;but&nbsp;there&nbsp;are&nbsp;probably&nbsp;easier&nbsp;and&nbsp;more&nbsp;effective&nbsp;methods.&nbsp;&nbsp;From&nbsp;a&nbsp;fragmentation&nbsp;perspective,&nbsp;the&nbsp;ideal&nbsp;jemalloc&nbsp;configuration&nbsp;is&nbsp;one&nbsp;arena,&nbsp;no&nbsp;thread&nbsp;caching,&nbsp;and&nbsp;&nbsp;a&nbsp;very&nbsp;high&nbsp;active:dirty&nbsp;ratio&nbsp;(prevents&nbsp;accumulation&nbsp;of&nbsp;unused&nbsp;dirty&nbsp;pages).&nbsp;&nbsp;You&nbsp;will&nbsp;probably&nbsp;find&nbsp;that&nbsp;you&nbsp;can&nbsp;tune&nbsp;one&nbsp;or&nbsp;more&nbsp;of&nbsp;these&nbsp;parameters&nbsp;in&nbsp;a&nbsp;way&nbsp;that&nbsp;reduces&nbsp;fragmentation&nbsp;without&nbsp;significantly&nbsp;impacting&nbsp;your&nbsp;application's&nbsp;throughput.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Jason&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
