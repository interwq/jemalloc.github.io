<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello&nbsp;Experts,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;have&nbsp;a&nbsp;static&nbsp;allocator&nbsp;based&nbsp;on&nbsp;shared&nbsp;memory&nbsp;in&nbsp;use&nbsp;today&nbsp;(with&nbsp;predefined&nbsp;memory&nbsp;segment&nbsp;sizes),&nbsp;but&nbsp;there&nbsp;is&nbsp;just&nbsp;too&nbsp;much&nbsp;of&nbsp;internal&nbsp;fragmentation&nbsp;and&nbsp;our&nbsp;memory&nbsp;requirement&nbsp;in&nbsp;keep&nbsp;on&nbsp;increasing&nbsp;(we&nbsp;have&nbsp;close&nbsp;to&nbsp;60-70GB&nbsp;in&nbsp;use&nbsp;today&nbsp;-&nbsp;with&nbsp;practically&nbsp;needing&nbsp;20-30GB).&nbsp;We&nbsp;tried&nbsp;several&nbsp;option&nbsp;to&nbsp;live&nbsp;with&nbsp;the&nbsp;current&nbsp;allocator&nbsp;but&nbsp;it&nbsp;is&nbsp;extremely&nbsp;hard&nbsp;to&nbsp;have&nbsp;a&nbsp;configuration&nbsp;which&nbsp;can&nbsp;work&nbsp;with&nbsp;varying&nbsp;traffic&nbsp;patterns. &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;To&nbsp;address&nbsp;the&nbsp;problem,&nbsp;I&nbsp;am&nbsp;considering&nbsp;to&nbsp;use&nbsp;a&nbsp;dynamic&nbsp;allocator&nbsp;based&nbsp;on&nbsp;shared&nbsp;memory.&nbsp;The&nbsp;basic&nbsp;idea&nbsp;is&nbsp;to&nbsp;have&nbsp;the&nbsp;allocator&nbsp;work&nbsp;across&nbsp;process&nbsp;boundaries&nbsp;and&nbsp;to&nbsp;have&nbsp;the&nbsp;things&nbsp;stored&nbsp;in&nbsp;shared&nbsp;memory&nbsp;to&nbsp;survive&nbsp;process&nbsp;crashes&nbsp;or&nbsp;restarts. &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;After&nbsp;analyzing&nbsp;many&nbsp;allocators,&nbsp;I&nbsp;am&nbsp;thinking&nbsp;to&nbsp;port&nbsp;jemalloc&nbsp;to&nbsp;shared&nbsp;memory.&nbsp;I&nbsp;have&nbsp;done&nbsp;a&nbsp;very&nbsp;high&nbsp;level&nbsp;look&nbsp;into&nbsp;jemalloc&nbsp;with&nbsp;a&nbsp;simple&nbsp;prototype.&nbsp;In&nbsp;my&nbsp;prototype&nbsp;I&nbsp;am&nbsp;pre-allocating&nbsp;a&nbsp;big&nbsp;shared&nbsp;memory&nbsp;chunk&nbsp;using&nbsp;a&nbsp;fixed&nbsp;address&nbsp;(which&nbsp;is&nbsp;aligned&nbsp;to&nbsp;chunk&nbsp;size&nbsp;boundary&nbsp;of&nbsp;4MB).&nbsp;With&nbsp;this&nbsp;I&nbsp;think&nbsp;jemalloc&nbsp;would&nbsp;be&nbsp;able&nbsp;to&nbsp;manage&nbsp;memory&nbsp;across&nbsp;processes.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;few&nbsp;queries&nbsp;in&nbsp;general,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1.&nbsp;Currently&nbsp;I&nbsp;am&nbsp;using&nbsp;a&nbsp;fixed&nbsp;address&nbsp;aligned&nbsp;to&nbsp;4MB&nbsp;boundary.&nbsp;Is&nbsp;there&nbsp;a&nbsp;way&nbsp;for&nbsp;me&nbsp;to&nbsp;avoid&nbsp;using&nbsp;a&nbsp;fixed&nbsp;address? &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2.&nbsp;Is&nbsp;it&nbsp;safe&nbsp;to&nbsp;use&nbsp;a&nbsp;fixed&nbsp;high&nbsp;memory&nbsp;address&nbsp;for&nbsp;my&nbsp;application?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;3.&nbsp;Is&nbsp;it&nbsp;possible&nbsp;to&nbsp;make&nbsp;jemalloc&nbsp;work&nbsp;with&nbsp;page&nbsp;alignment&nbsp;for&nbsp;chunks&nbsp;instead&nbsp;of&nbsp;chunk&nbsp;alignment?&nbsp;If&nbsp;yes,&nbsp;could&nbsp;you&nbsp;suggest&nbsp;any&nbsp;way&nbsp;for&nbsp;this&nbsp;-&nbsp;without&nbsp;huge&nbsp;rework&nbsp;in&nbsp;jemalloc?&nbsp;My&nbsp;primary&nbsp;idea&nbsp;is&nbsp;to&nbsp;get&nbsp;out&nbsp;of&nbsp;fixed&nbsp;address&nbsp;(AFAIK,&nbsp;Linux&nbsp;guarantees&nbsp;shared&nbsp;memory&nbsp;segments&nbsp;to&nbsp;be&nbsp;page&nbsp;aligned)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;4.&nbsp;I&nbsp;see&nbsp;that&nbsp;tsd&nbsp;cleanup&nbsp;do&nbsp;not&nbsp;work&nbsp;(including&nbsp;arena&nbsp;cleanup)&nbsp;when&nbsp;process&nbsp;exits.&nbsp;Is&nbsp;there&nbsp;a&nbsp;way&nbsp;to&nbsp;ensure&nbsp;this?&nbsp;Or&nbsp;do&nbsp;I&nbsp;need&nbsp;to&nbsp;introduce&nbsp;some&nbsp;garbage&nbsp;collection&nbsp;mechanism&nbsp;on&nbsp;top?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;and&nbsp;Regards,&lt;br&gt;&lt;/div&gt;&lt;div&gt;Abi&lt;/div&gt;&lt;/div&gt;<br>

</tt>
