<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Here&#39;s&nbsp;the&nbsp;CL&nbsp;I&nbsp;submitted&nbsp;to&nbsp;our&nbsp;git&nbsp;respository:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;https://android-review.googlesource.com/#/c/200798/&quot;&gt;https://android-review.googlesource.com/#/c/200798/&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;think&nbsp;this&nbsp;is&nbsp;portable,&nbsp;but&nbsp;I&#39;ve&nbsp;only&nbsp;verified&nbsp;that&nbsp;this&nbsp;works&nbsp;on&nbsp;gcc&nbsp;4.9/current&nbsp;clang. &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;On&nbsp;a&nbsp;sort&nbsp;of&nbsp;related&nbsp;note,&nbsp;there&nbsp;is&nbsp;a&nbsp;typo&nbsp;in&nbsp;jemalloc/internal/ckh.h.&nbsp;The&nbsp;prototype&nbsp;for&nbsp;ckh_search,&nbsp;has&nbsp;the&nbsp;second&nbsp;parameter&nbsp;as&nbsp;seachkey&nbsp;instead&nbsp;of&nbsp;searchkey.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Christopher &lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Feb&nbsp;1,&nbsp;2016&nbsp;at&nbsp;3:51&nbsp;PM,&nbsp;Christopher&nbsp;Ferris&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:cferris@google.com&quot;&nbsp;target=&quot;_blank&quot;&gt;cferris@google.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;When&nbsp;I&nbsp;compiled&nbsp;the&nbsp;ckh&nbsp;unit&nbsp;test&nbsp;with&nbsp;a&nbsp;newer&nbsp;version&nbsp;of&nbsp;clang,&nbsp;it&nbsp;was&nbsp;crashing.&nbsp;I&nbsp;tracked&nbsp;the&nbsp;problem&nbsp;down&nbsp;to&nbsp;an&nbsp;implicit&nbsp;assumption&nbsp;that&nbsp;a&nbsp;value&nbsp;passed&nbsp;to&nbsp;chk_search&nbsp;is&nbsp;4&nbsp;byte&nbsp;aligned.&nbsp;Specifically,&nbsp;the&nbsp;code&nbsp;in&nbsp;test/unit/ckh.c,&nbsp;the&nbsp;test test_count_insert_search_remove,&nbsp;makes&nbsp;this&nbsp;call:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp;assert_true(ckh_search(&amp;ckh,&nbsp;missing,&nbsp;NULL,&nbsp;NULL),&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp;&quot;Unexpected&nbsp;ckh_search()&nbsp;success&quot;);&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;the&nbsp;definition&nbsp;of&nbsp;missing&nbsp;is:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp;char&nbsp;*missing&nbsp;= &quot;A&nbsp;string&nbsp;not&nbsp;in&nbsp;the&nbsp;hash&nbsp;table.&quot;;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Which&nbsp;means&nbsp;missing&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;of&nbsp;any&nbsp;alignment.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;m&nbsp;not&nbsp;sure&nbsp;on&nbsp;what&nbsp;platforms&nbsp;jemalloc&nbsp;needs&nbsp;to&nbsp;be&nbsp;compiled,&nbsp;so&nbsp;I&nbsp;think&nbsp;that&nbsp;something&nbsp;like&nbsp;this:&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp;#define&nbsp;HASH_TABLE_STRING&nbsp;&quot;A&nbsp;string&nbsp;not&nbsp;in&nbsp;the&nbsp;hash&nbsp;table.&quot;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp;union&nbsp;{&nbsp;char&nbsp;char_data[sizeof(HASH_TABLE_STRING)];&nbsp;uint32_t&nbsp;uint_data;&nbsp;}&nbsp;missing;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp;memcpy(missing.char_data,&nbsp;HASH_TABLE_STRING,&nbsp;sizeof(HASH_TABLE_STRING));&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp;.&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp;.&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp;.&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp;assert_true(ckh_search(&amp;ckh,&nbsp;missing.char_data,&nbsp;NULL,&nbsp;NULL),&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp;&quot;Unexpected&nbsp;ckh_search()&nbsp;success&quot;);&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Would&nbsp;guarantee&nbsp;the&nbsp;needed&nbsp;alignment.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Does&nbsp;this&nbsp;seem&nbsp;reasonable?&lt;/div&gt;&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Christopher&lt;/div&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
