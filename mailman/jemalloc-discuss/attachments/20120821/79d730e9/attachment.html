<tt>
Hi,&lt;br&gt;&lt;br&gt;I&nbsp;am&nbsp;attaching&nbsp;a&nbsp;patch&nbsp;that&nbsp;allows&nbsp;to&nbsp;iterate&nbsp;over&nbsp;all&nbsp;objects.&lt;br&gt;&lt;br&gt;This&nbsp;is&nbsp;not&nbsp;a&nbsp;request&nbsp;for&nbsp;upstreaming:&nbsp;these&nbsp;patches&nbsp;cause&nbsp;crashes&nbsp;and&nbsp;I&nbsp;need&nbsp;help&nbsp;understanding&nbsp;these.&nbsp;And&nbsp;even&nbsp;if&nbsp;it&nbsp;didn&#39;t&nbsp;crash,&nbsp;this&nbsp;patch&nbsp;causes&nbsp;a&nbsp;severe&nbsp;overhead&nbsp;in&nbsp;memory&nbsp;usage&nbsp;and&nbsp;no&nbsp;attempt&nbsp;has&nbsp;been&nbsp;made&nbsp;to&nbsp;mitigate&nbsp;it.&nbsp;The&nbsp;goal&nbsp;of&nbsp;this&nbsp;effort&nbsp;is&nbsp;to&nbsp;allow&nbsp;custom&nbsp;developer&nbsp;builds&nbsp;of&nbsp;Firefox&nbsp;to&nbsp;introspect&nbsp;their&nbsp;own&nbsp;allocated&nbsp;blocks.&lt;br&gt;<br>
&lt;br&gt;The&nbsp;patch&nbsp;(attached&nbsp;to&nbsp;this&nbsp;email)&nbsp;works&nbsp;by&nbsp;renaming&nbsp;the&nbsp;public&nbsp;functions&nbsp;such&nbsp;as&nbsp;je_malloc()&nbsp;to&nbsp;real_je_malloc()&nbsp;and&nbsp;implementing&nbsp;custom&nbsp;je_malloc()&nbsp;to&nbsp;allocate&nbsp;a&nbsp;larger&nbsp;block,&nbsp;and&nbsp;use&nbsp;the&nbsp;extra&nbsp;space&nbsp;to&nbsp;store&nbsp;the&nbsp;data&nbsp;of&nbsp;a&nbsp;doubly-linked&nbsp;list&nbsp;element.&lt;br&gt;<br>
&lt;br&gt;In&nbsp;principle,&nbsp;this&nbsp;should&nbsp;be&nbsp;entirely&nbsp;transparent&nbsp;to&nbsp;the&nbsp;user&nbsp;(except&nbsp;for&nbsp;the&nbsp;increased&nbsp;memory&nbsp;usage),&nbsp;so&nbsp;I&nbsp;don&#39;t&nbsp;understand&nbsp;the&nbsp;crashes.&lt;br&gt;&lt;br&gt;The&nbsp;crashes&nbsp;aren&#39;t&nbsp;immediate:&nbsp;I&nbsp;can&nbsp;run&nbsp;Firefox&nbsp;(this&nbsp;patch&nbsp;if&nbsp;for&nbsp;Firefox&#39;s&nbsp;copy&nbsp;of&nbsp;jemalloc&nbsp;3.0)&nbsp;for&nbsp;a&nbsp;while&nbsp;and&nbsp;browse&nbsp;a&nbsp;few&nbsp;pages&nbsp;without&nbsp;crashing.&lt;br&gt;<br>
&lt;br&gt;The&nbsp;crashes&nbsp;are&nbsp;assertion&nbsp;failures&nbsp;like&nbsp;this:&lt;br&gt;&lt;br&gt;Program&nbsp;received&nbsp;signal&nbsp;SIGSEGV,&nbsp;Segmentation&nbsp;fault.&lt;br&gt;0x0000000000411605&nbsp;in&nbsp;moz_abort&nbsp;()&lt;br&gt;   &nbsp;at&nbsp;/hack/mozilla-central/memory/build/extraMallocFuncs.c:116&lt;br&gt;116      &nbsp;MOZ_CRASH();&lt;br&gt;<br>
(gdb)&nbsp;bt&lt;br&gt;#0 &nbsp;0x0000000000411605&nbsp;in&nbsp;moz_abort&nbsp;()&lt;br&gt;   &nbsp;at&nbsp;/hack/mozilla-central/memory/build/extraMallocFuncs.c:116&lt;br&gt;#1 &nbsp;0x000000000041afdf&nbsp;in&nbsp;arena_bin_malloc_hard&nbsp;(arena=0x7ffff6c00180,&nbsp;bin=0x7ffff6c007c8)&lt;br&gt;   &nbsp;at&nbsp;/hack/mozilla-central/memory/jemalloc/src/src/arena.c:1189&lt;br&gt;<br>
#2 &nbsp;0x000000000041b225&nbsp;in&nbsp;arena_tcache_fill_small&nbsp;(arena=0x7ffff6c00180,&nbsp;&lt;br&gt;   &nbsp;tbin=0x7ffff6b02148,&nbsp;binind=9,&nbsp;prof_accumbytes=0)&lt;br&gt;   &nbsp;at&nbsp;/hack/mozilla-central/memory/jemalloc/src/src/arena.c:1232&lt;br&gt;#3 &nbsp;0x000000000043c239&nbsp;in&nbsp;tcache_alloc_small_hard&nbsp;(tcache=0x7ffff6b02000,&nbsp;&lt;br&gt;<br>
   &nbsp;tbin=0x7ffff6b02148,&nbsp;binind=9)&lt;br&gt;   &nbsp;at&nbsp;/hack/mozilla-central/memory/jemalloc/src/src/tcache.c:72&lt;br&gt;#4 &nbsp;0x000000000043b7dc&nbsp;in&nbsp;tcache_alloc_small&nbsp;(tcache=0x7ffff6b02000,&nbsp;size=160,&nbsp;zero=false)&lt;br&gt;   &nbsp;at&nbsp;/hack/mozilla-central/memory/jemalloc/src/include/jemalloc/internal/tcache.h:302&lt;br&gt;<br>
#5 &nbsp;0x0000000000412c26&nbsp;in&nbsp;arena_malloc&nbsp;(arena=0x0,&nbsp;size=160,&nbsp;zero=false,&nbsp;try_tcache=true)&lt;br&gt;   &nbsp;at&nbsp;/hack/mozilla-central/memory/jemalloc/src/include/jemalloc/internal/arena.h:869&lt;br&gt;#6 &nbsp;0x000000000042dce8&nbsp;in&nbsp;imalloc&nbsp;(size=160)&lt;br&gt;<br>
   &nbsp;at&nbsp;src/include/jemalloc/internal/jemalloc_internal.h:735&lt;br&gt;#7 &nbsp;0x000000000043111c&nbsp;in&nbsp;real_je_malloc&nbsp;(size=160)&lt;br&gt;   &nbsp;at&nbsp;/hack/mozilla-central/memory/jemalloc/src/src/jemalloc.c:829&lt;br&gt;#8 &nbsp;0x0000000000432fa3&nbsp;in&nbsp;malloc&nbsp;(size=128)&lt;br&gt;<br>
   &nbsp;at&nbsp;/hack/mozilla-central/memory/jemalloc/src/src/jemalloc.c:1425&lt;br&gt;#9 &nbsp;0x00007ffff7fe803c&nbsp;in&nbsp;moz_xmalloc&nbsp;(size=128)&lt;br&gt;   &nbsp;at&nbsp;/hack/mozilla-central/memory/mozalloc/mozalloc.cpp:57&lt;br&gt;#10&nbsp;0x00007ffff2dcb74d&nbsp;in&nbsp;nsTArrayInfallibleAllocator::Malloc&nbsp;(size=128)&lt;br&gt;<br>
   &nbsp;at&nbsp;../../dist/include/nsTArray.h:56&lt;br&gt;...&lt;br&gt;&lt;br&gt;Printing&nbsp;some&nbsp;variables&nbsp;here:&lt;br&gt;&lt;br&gt;(gdb)&nbsp;up&lt;br&gt;#1 &nbsp;0x000000000041afdf&nbsp;in&nbsp;arena_bin_malloc_hard&nbsp;(arena=0x7ffff6c00180,&nbsp;bin=0x7ffff6c007c8)&lt;br&gt;   &nbsp;at&nbsp;/hack/mozilla-central/memory/jemalloc/src/src/arena.c:1189&lt;br&gt;<br>
1189           &nbsp;assert(bin-&gt;runcur-&gt;nfree&nbsp;&gt;&nbsp;0);&lt;br&gt;(gdb)&nbsp;p&nbsp;bin&lt;br&gt;$1&nbsp;=&nbsp;(arena_bin_t&nbsp;*)&nbsp;0x7ffff6c007c8&lt;br&gt;(gdb)&nbsp;p&nbsp;*bin&lt;br&gt;$2&nbsp;=&nbsp;{lock&nbsp;=&nbsp;{lock&nbsp;=&nbsp;{__data&nbsp;=&nbsp;{__lock&nbsp;=&nbsp;1,&nbsp;__count&nbsp;=&nbsp;0,&nbsp;__owner&nbsp;=&nbsp;6469,&nbsp;__nusers&nbsp;=&nbsp;1,&nbsp;&lt;br&gt;<br>
       &nbsp;__kind&nbsp;=&nbsp;0,&nbsp;__spins&nbsp;=&nbsp;0,&nbsp;__list&nbsp;=&nbsp;{__prev&nbsp;=&nbsp;0x0,&nbsp;__next&nbsp;=&nbsp;0x0}},&nbsp;&lt;br&gt;     &nbsp;__size&nbsp;=&nbsp;&quot;\001\000\000\000\000\000\000\000E\031\000\000\001&quot;,&nbsp;&#39;\000&#39;&nbsp;&lt;repeats&nbsp;26&nbsp;times&gt;,&nbsp;__align&nbsp;=&nbsp;1}},&nbsp;runcur&nbsp;=&nbsp;0x7fffc2ced000,&nbsp;runs&nbsp;=&nbsp;{rbt_root&nbsp;=&nbsp;0x7fffca3004d8,&nbsp;rbt_nil&nbsp;=&nbsp;{{&lt;br&gt;<br>
       &nbsp;u&nbsp;=&nbsp;{rb_link&nbsp;=&nbsp;{rbn_left&nbsp;=&nbsp;0x7ffff6c00800,&nbsp;rbn_right_red&nbsp;=&nbsp;0x7ffff6c00800},&nbsp;&lt;br&gt;         &nbsp;ql_link&nbsp;=&nbsp;{qre_next&nbsp;=&nbsp;0x7ffff6c00800,&nbsp;qre_prev&nbsp;=&nbsp;0x7ffff6c00800}},&nbsp;&lt;br&gt;       &nbsp;prof_ctx&nbsp;=&nbsp;0x7ffff6c00800},&nbsp;bits&nbsp;=&nbsp;0}},&nbsp;stats&nbsp;=&nbsp;{allocated&nbsp;=&nbsp;8896000,&nbsp;&lt;br&gt;<br>
   &nbsp;nmalloc&nbsp;=&nbsp;197757,&nbsp;ndalloc&nbsp;=&nbsp;142157,&nbsp;nrequests&nbsp;=&nbsp;300344,&nbsp;nfills&nbsp;=&nbsp;5545,&nbsp;&lt;br&gt;   &nbsp;nflushes&nbsp;=&nbsp;2848,&nbsp;nruns&nbsp;=&nbsp;2802,&nbsp;reruns&nbsp;=&nbsp;5838,&nbsp;curruns&nbsp;=&nbsp;1143}}&lt;br&gt;(gdb)&nbsp;p&nbsp;bin-&gt;runcur&lt;br&gt;$3&nbsp;=&nbsp;(arena_run_t&nbsp;*)&nbsp;0x7fffc2ced000&lt;br&gt;(gdb)&nbsp;p&nbsp;*(bin-&gt;runcur)&lt;br&gt;<br>
$4&nbsp;=&nbsp;{bin&nbsp;=&nbsp;0x7ffff6c007c8,&nbsp;nextind&nbsp;=&nbsp;4544384,&nbsp;nfree&nbsp;=&nbsp;0}&lt;br&gt;&lt;br&gt;Any&nbsp;help&nbsp;would&nbsp;be&nbsp;greatly&nbsp;appreciated.&lt;br&gt;&lt;br&gt;Thanks,&lt;br&gt;Benoit&lt;br&gt;<br>

</tt>
