<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Heya,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;We&#39;re&nbsp;currently&nbsp;using&nbsp;jemalloc&nbsp;2.2.5&nbsp;statically&nbsp;linked&nbsp;into&nbsp;a&nbsp;private&nbsp;fork&nbsp;of&nbsp;Varnish&nbsp;with&nbsp;a&nbsp;very&nbsp;high&nbsp;rate&nbsp;of&nbsp;malloc/calloc/free,&nbsp;and&nbsp;we&#39;re&nbsp;seeing&nbsp;segfaults&nbsp;on&nbsp;a&nbsp;somewhat&nbsp;frequent&nbsp;basis.&nbsp;(one&nbsp;a&nbsp;day&nbsp;on&nbsp;a&nbsp;group&nbsp;of&nbsp;6&nbsp;hosts.)&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;We&nbsp;had&nbsp;the&nbsp;same&nbsp;segfaults&nbsp;with&nbsp;2.2.3,&nbsp;and&nbsp;upgrading&nbsp;to&nbsp;2.2.5&nbsp;seems&nbsp;not&nbsp;to&nbsp;have&nbsp;helped.&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;(Also,&nbsp;we&nbsp;tried&nbsp;upgrading&nbsp;to&nbsp;3.3.1&nbsp;and&nbsp;things&nbsp;just&nbsp;got&nbsp;worse,&nbsp;tried&nbsp;enabling&nbsp;debugging&nbsp;which&nbsp;made&nbsp;it&nbsp;even&nbsp;more&nbsp;worse.&nbsp;Under&nbsp;time&nbsp;pressure,&nbsp;we&nbsp;dropped&nbsp;down&nbsp;to&nbsp;2.2.5)&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;I&nbsp;should&nbsp;mention&nbsp;that&nbsp;I&nbsp;backported&nbsp;the&nbsp;mmap&nbsp;strategy&nbsp;from&nbsp;3.3.1&nbsp;into&nbsp;2.2.5,&nbsp;to&nbsp;prevent&nbsp;VM&nbsp;fragmentation,&nbsp;which&nbsp;was&nbsp;causing&nbsp;us&nbsp;to&nbsp;run&nbsp;into&nbsp;vm.max_map_count.&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;<br>
So,&nbsp;to&nbsp;the&nbsp;meat&nbsp;of&nbsp;the&nbsp;problem!&nbsp;(We&nbsp;saw&nbsp;these&nbsp;in&nbsp;both&nbsp;2.2.3&nbsp;without&nbsp;the&nbsp;mmap&nbsp;strategy&nbsp;backported,&nbsp;and&nbsp;2.2.5&nbsp;with&nbsp;mmap&nbsp;strategy&nbsp;backported.) &lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;core&nbsp;files&nbsp;(we&#39;re&nbsp;running&nbsp;with&nbsp;153G&nbsp;resident,&nbsp;and&nbsp;4075G&nbsp;virtual&nbsp;process&nbsp;size&nbsp;on&nbsp;one&nbsp;of&nbsp;the&nbsp;hosts&nbsp;that&nbsp;I&#39;m&nbsp;looking&nbsp;at&nbsp;right&nbsp;now)&nbsp;so&nbsp;the&nbsp;internal&nbsp;Varnish&nbsp;(libgcc&nbsp;based)&nbsp;backtrace&nbsp;is&nbsp;all&nbsp;we&nbsp;have:&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;div&nbsp;style=&quot;font-size:13px&quot;&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;b&gt;0x483894&lt;/b&gt;: &lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;background-color:rgb(255,255,204)&quot;&gt;arena_tcache_fill_small&lt;/span&gt;+1a4&lt;br&gt;&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&nbsp;style=&quot;font-size:13px&quot;&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;0x4916b9:&nbsp;tcache_alloc_small_hard+19&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:13px&quot;&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;0x4841bf:&nbsp;arena_malloc+1bf&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:13px&quot;&gt;<br>
&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;0x47b498:&nbsp;calloc+218&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;Looking&nbsp;that&nbsp;up:&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;#&nbsp;addr2line&nbsp;-e&nbsp;/usr/sbin/varnishd&nbsp;-i&nbsp;0x483894&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;/varnish-cache/lib/libjemalloc/include/jemalloc/internal/bitmap.h:101&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;/varnish-cache/lib/libjemalloc/include/jemalloc/internal/bitmap.h:140&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;/varnish-cache/lib/libjemalloc/src/arena.c:264&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;/varnish-cache/lib/libjemalloc/src/arena.c:1395&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;Which&nbsp;looks&nbsp;like:&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;97&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;goff&nbsp;=&nbsp;bit&nbsp;&gt;&gt;&nbsp;LG_BITMAP_GROUP_NBITS;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;98&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;gp&nbsp;=&nbsp;&amp;bitmap[goff];&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;99&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;g&nbsp;=&nbsp;*gp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;assert(g&nbsp;&amp;&nbsp;(1LU&nbsp;&lt;&lt;&nbsp;(bit&nbsp;&amp;&nbsp;BITMAP_GROUP_NBITS_MASK)));&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;b&gt;101&lt;/b&gt;&nbsp;&nbsp;&lt;/span&gt;g&nbsp;^=&nbsp;1LU&nbsp;&lt;&lt;&nbsp;(bit&nbsp;&amp;&nbsp;BITMAP_GROUP_NBITS_MASK);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;102&nbsp;&lt;/span&gt;*gp&nbsp;=&nbsp;g;&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;Which&nbsp;makes&nbsp;no&nbsp;sense&nbsp;at&nbsp;first,&nbsp;since&nbsp;there&#39;s&nbsp;no&nbsp;deref&nbsp;being&nbsp;done&nbsp;there,&nbsp;but&nbsp;a&nbsp;disassembly&nbsp;(thanks&nbsp;Devon)&nbsp;shows:&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt; &nbsp;483883:&nbsp; &nbsp; &nbsp; &nbsp;48&nbsp;c1&nbsp;ef&nbsp;06&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;shr&nbsp; &nbsp; $0x6,%rdi&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt; &nbsp;483887:&nbsp; &nbsp; &nbsp; &nbsp;83&nbsp;e1&nbsp;3f&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; and&nbsp; &nbsp; $0x3f,%ecx&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt; &nbsp;48388a:&nbsp; &nbsp; &nbsp; &nbsp;4c&nbsp;8d&nbsp;04&nbsp;fa&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lea&nbsp; &nbsp; (%rdx,%rdi,8),%r8&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt; &nbsp;48388e:&nbsp; &nbsp; &nbsp; &nbsp;49&nbsp;d3&nbsp;e1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shl&nbsp; &nbsp; %cl,%r9&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt; &nbsp;483891:&nbsp; &nbsp; &nbsp; &nbsp;4c&nbsp;89&nbsp;c9&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov&nbsp; &nbsp; %r9,%rcx&lt;/font&gt;&lt;/div&gt;&lt;div&gt;<br>
&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt; &nbsp;&lt;b&gt;483894&lt;/b&gt;:&nbsp; &nbsp; &nbsp; &nbsp;49&nbsp;33&nbsp;08&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor&nbsp; &nbsp; (%r8),%rcx&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;The&nbsp;optimizer&nbsp;got&nbsp;rid&nbsp;of&nbsp;g&nbsp;and&nbsp;just&nbsp;does&nbsp;the&nbsp;xor&nbsp;straight&nbsp;on&nbsp;*gp.&nbsp;So&nbsp;gp&nbsp;is&nbsp;an&nbsp;illegal&nbsp;address.&nbsp;According&nbsp;to&nbsp;our&nbsp;segfault&nbsp;handler,&nbsp;it&#39;s&nbsp;NULL.&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;For&nbsp;gp&nbsp;to&nbsp;be&nbsp;NULL,&nbsp;both&nbsp;bitmap&nbsp;and&nbsp;goff&nbsp;need&nbsp;to&nbsp;be&nbsp;NULL.&nbsp;And&nbsp;bitmap&nbsp;being&nbsp;NULL&nbsp;is&nbsp;somewhat&nbsp;impossible&nbsp;due&nbsp;to:&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;if&nbsp;((run&nbsp;=&nbsp;bin-&gt;runcur)&nbsp;!=&nbsp;NULL&nbsp;&amp;&amp;&nbsp;run-&gt;nfree&nbsp;&gt;&nbsp;0)&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;face=&quot;courier&nbsp;new,&nbsp;monospace&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;ptr&nbsp;=&nbsp;arena_run_reg_alloc(run,&nbsp;&amp;arena_bin_info[binind]);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;bitmap&nbsp;is&nbsp;an&nbsp;offset&nbsp;to&nbsp;run,&nbsp;so&nbsp;both&nbsp;the&nbsp;offset&nbsp;and&nbsp;the&nbsp;run&nbsp;need&nbsp;to&nbsp;be&nbsp;NULL&nbsp;(or&nbsp;perfectly&nbsp;matched&nbsp;to&nbsp;cancel&nbsp;eachother&nbsp;out,&nbsp;but&nbsp;also&nbsp;unlikely.)&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;bin-&gt;runcur&nbsp;and&nbsp;bin-&gt;bitmap_offset&nbsp;both&nbsp;being&nbsp;NULL&nbsp;seems&nbsp;_very_&nbsp;unlikely.&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;And&nbsp;that&#39;s&nbsp;about&nbsp;as&nbsp;far&nbsp;as&nbsp;we&#39;ve&nbsp;gotten.&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;Help?&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt; &nbsp; &nbsp; &nbsp;Doc&nbsp;&amp;&nbsp;Devon&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
