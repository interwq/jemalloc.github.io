<tt>
&lt;html&nbsp;xmlns:v=&quot;urn:schemas-microsoft-com:vml&quot;&nbsp;xmlns:o=&quot;urn:schemas-microsoft-com:office:office&quot;&nbsp;xmlns:w=&quot;urn:schemas-microsoft-com:office:word&quot;&nbsp;xmlns:m=&quot;http://schemas.microsoft.com/office/2004/12/omml&quot;&nbsp;xmlns=&quot;http://www.w3.org/TR/REC-html40&quot;&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=us-ascii&quot;&gt;<br>
&lt;meta&nbsp;name=&quot;Generator&quot;&nbsp;content=&quot;Microsoft&nbsp;Word&nbsp;14&nbsp;(filtered&nbsp;medium)&quot;&gt;<br>
&lt;style&gt;&lt;!--<br>
/*&nbsp;Font&nbsp;Definitions&nbsp;*/<br>
@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:Helvetica;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:2&nbsp;11&nbsp;6&nbsp;4&nbsp;2&nbsp;2&nbsp;2&nbsp;2&nbsp;2&nbsp;4;}<br>
@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:\5B8B\4F53;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:2&nbsp;1&nbsp;6&nbsp;0&nbsp;3&nbsp;1&nbsp;1&nbsp;1&nbsp;1&nbsp;1;}<br>
@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:\5B8B\4F53;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:2&nbsp;1&nbsp;6&nbsp;0&nbsp;3&nbsp;1&nbsp;1&nbsp;1&nbsp;1&nbsp;1;}<br>
@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:Calibri;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:2&nbsp;15&nbsp;5&nbsp;2&nbsp;2&nbsp;2&nbsp;4&nbsp;3&nbsp;2&nbsp;4;}<br>
@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:Consolas;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:2&nbsp;11&nbsp;6&nbsp;9&nbsp;2&nbsp;2&nbsp;4&nbsp;3&nbsp;2&nbsp;4;}<br>
@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:&quot;\@\5B8B\4F53&quot;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:2&nbsp;1&nbsp;6&nbsp;0&nbsp;3&nbsp;1&nbsp;1&nbsp;1&nbsp;1&nbsp;1;}<br>
/*&nbsp;Style&nbsp;Definitions&nbsp;*/<br>
p.MsoNormal,&nbsp;li.MsoNormal,&nbsp;div.MsoNormal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{margin:0cm;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;margin-bottom:.0001pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-align:justify;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-justify:inter-ideograph;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-size:10.5pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;}<br>
a:link,&nbsp;span.MsoHyperlink<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-priority:99;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:blue;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-decoration:underline;}<br>
a:visited,&nbsp;span.MsoHyperlinkFollowed<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-priority:99;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:purple;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-decoration:underline;}<br>
p<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-priority:99;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-margin-top-alt:auto;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;margin-right:0cm;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-margin-bottom-alt:auto;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;margin-left:0cm;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-size:12.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:\5B8B\4F53;}<br>
code<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-priority:99;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:Consolas;}<br>
pre<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-priority:99;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-style-link:&quot;HTML&nbsp;Preformatted&nbsp;Char&quot;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;margin:0cm;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;margin-bottom:.0001pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-size:9.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:Consolas;}<br>
span.EmailStyle17<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-type:personal-compose;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:windowtext;}<br>
span.HTMLPreformattedChar<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-name:&quot;HTML&nbsp;Preformatted&nbsp;Char&quot;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-style-priority:99;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-style-link:&quot;HTML&nbsp;Preformatted&quot;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:Consolas;}<br>
.MsoChpDefault<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-type:export-only;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;}<br>
/*&nbsp;Page&nbsp;Definitions&nbsp;*/<br>
@page&nbsp;WordSection1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{size:612.0pt&nbsp;792.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;margin:72.0pt&nbsp;90.0pt&nbsp;72.0pt&nbsp;90.0pt;}<br>
div.WordSection1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{page:WordSection1;}<br>
--&gt;&lt;/style&gt;&lt;!--[if&nbsp;gte&nbsp;mso&nbsp;9]&gt;&lt;xml&gt;<br>
&lt;o:shapedefaults&nbsp;v:ext=&quot;edit&quot;&nbsp;spidmax=&quot;1026&quot;&nbsp;/&gt;<br>
&lt;/xml&gt;&lt;![endif]--&gt;&lt;!--[if&nbsp;gte&nbsp;mso&nbsp;9]&gt;&lt;xml&gt;<br>
&lt;o:shapelayout&nbsp;v:ext=&quot;edit&quot;&gt;<br>
&lt;o:idmap&nbsp;v:ext=&quot;edit&quot;&nbsp;data=&quot;1&quot;&nbsp;/&gt;<br>
&lt;/o:shapelayout&gt;&lt;/xml&gt;&lt;![endif]--&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;lang=&quot;ZH-CN&quot;&nbsp;link=&quot;blue&quot;&nbsp;vlink=&quot;purple&quot;&nbsp;style=&quot;text-justify-trim:punctuation&quot;&gt;<br>
&lt;div&nbsp;class=&quot;WordSection1&quot;&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;align=&quot;left&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;text-align:left&quot;&gt;<br>
&lt;span&nbsp;lang=&quot;EN&quot;&nbsp;style=&quot;font-family:&quot;Helvetica&quot;,&quot;sans-serif&quot;;color:#333333&quot;&gt;Hi,&nbsp;all&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;align=&quot;left&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;text-align:left;text-indent:21.0pt&quot;&gt;<br>
&lt;span&nbsp;lang=&quot;EN&quot;&nbsp;style=&quot;font-family:&quot;Helvetica&quot;,&quot;sans-serif&quot;;color:#333333&quot;&gt;when&nbsp;i&nbsp;read&nbsp;the&nbsp;src&nbsp;code&nbsp;of&nbsp;jemalloc&nbsp;of&nbsp;redis,&nbsp;i'm&nbsp;confused&nbsp;for&nbsp;below&nbsp;code&nbsp;in&nbsp;malloc_init_hard()&nbsp;function.&nbsp;do&nbsp;you&nbsp;know&nbsp;what's&nbsp;mean&nbsp;of&nbsp;IS_INITIALIZER,&nbsp;it&nbsp;said&nbsp;that&nbsp;it&nbsp;for:&nbsp;this&nbsp;thread<br>
&nbsp;is&nbsp;the&nbsp;initializing&nbsp;thread,&nbsp;and&nbsp;it&nbsp;is&nbsp;recursively&nbsp;allocating.&nbsp;what's&nbsp;the&nbsp;mean&nbsp;of&nbsp;the&nbsp;sentence?&nbsp;could&nbsp;you&nbsp;take&nbsp;an&nbsp;example&nbsp;for&nbsp;it?&nbsp;another&nbsp;question&nbsp;is&nbsp;if&nbsp;one&nbsp;thread&nbsp;is&nbsp;initializing,&nbsp;and&nbsp;this&nbsp;thread&nbsp;will&nbsp;wait&nbsp;for&nbsp;init_lock,&nbsp;after&nbsp;that&nbsp;thread&nbsp;finish&nbsp;the&nbsp;initializing.<br>
&nbsp;then&nbsp;the&nbsp;malloc_initialized&nbsp;will&nbsp;be&nbsp;set&nbsp;to&nbsp;true.&nbsp;then&nbsp;this&nbsp;thread&nbsp;will&nbsp;return&nbsp;false.&nbsp;but&nbsp;malloc_init_hard&nbsp;in&nbsp;invoked&nbsp;by&nbsp;je_malloc,&nbsp;so&nbsp;for&nbsp;this&nbsp;thread&nbsp;the&nbsp;je_malloc&nbsp;will&nbsp;be&nbsp;return&nbsp;false?&nbsp;and&nbsp;then&nbsp;allocated&nbsp;fail????&nbsp;thanks&nbsp;for&nbsp;your&nbsp;time.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;align=&quot;left&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;text-align:left&quot;&gt;<br>
&lt;span&nbsp;lang=&quot;EN&quot;&nbsp;style=&quot;font-family:&quot;Helvetica&quot;,&quot;sans-serif&quot;;color:#333333&quot;&gt;static&nbsp;bool&lt;br&gt;<br>
malloc_init_hard(void)&lt;br&gt;<br>
{&lt;br&gt;<br>
arena_t&nbsp;*init_arenas[1];&lt;br&gt;<br>
malloc_mutex_lock(&amp;init_lock);&lt;br&gt;<br>
if&nbsp;(malloc_initialized&nbsp;||&nbsp;IS_INITIALIZER)&nbsp;{&nbsp;&lt;br&gt;<br>
*&nbsp;Another&nbsp;thread&nbsp;initialized&nbsp;the&nbsp;allocator&nbsp;before&nbsp;this&nbsp;one&lt;br&gt;<br>
*&nbsp;acquired&nbsp;init_lock,&nbsp;or&nbsp;this&nbsp;thread&nbsp;is&nbsp;the&nbsp;initializing&lt;br&gt;<br>
*&nbsp;thread,&nbsp;and&nbsp;it&nbsp;is&nbsp;recursively&nbsp;allocating.&lt;br&gt;<br>
*/&lt;br&gt;<br>
malloc_mutex_unlock(&amp;init_lock);&lt;br&gt;<br>
return&nbsp;(false);&lt;br&gt;<br>
}&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;align=&quot;left&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;text-align:left&quot;&gt;<br>
&lt;span&nbsp;lang=&quot;EN&quot;&nbsp;style=&quot;font-family:&quot;Helvetica&quot;,&quot;sans-serif&quot;;color:#333333&quot;&gt;void&nbsp;*&lt;br&gt;<br>
je_malloc(size_t&nbsp;size)&lt;br&gt;<br>
{&lt;br&gt;<br>
void&nbsp;*ret;&lt;br&gt;<br>
size_t&nbsp;usize&nbsp;JEMALLOC_CC_SILENCE_INIT(0);&lt;br&gt;<br>
prof_thr_cnt_t&nbsp;*cnt&nbsp;JEMALLOC_CC_SILENCE_INIT(NULL);&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;align=&quot;left&quot;&nbsp;style=&quot;text-align:left&quot;&gt;&lt;span&nbsp;lang=&quot;EN&quot;&nbsp;style=&quot;font-size:9.0pt;font-family:Consolas;color:#333333&quot;&gt;if&nbsp;(malloc_init())&nbsp;{&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;align=&quot;left&quot;&nbsp;style=&quot;text-align:left&quot;&gt;&lt;span&nbsp;lang=&quot;EN&quot;&nbsp;style=&quot;font-size:9.0pt;font-family:Consolas;color:#333333&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;NULL;&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;align=&quot;left&quot;&nbsp;style=&quot;text-align:left&quot;&gt;&lt;span&nbsp;lang=&quot;EN&quot;&nbsp;style=&quot;font-size:9.0pt;font-family:Consolas;color:#333333&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;label_oom;&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;align=&quot;left&quot;&nbsp;style=&quot;text-align:left&quot;&gt;&lt;span&nbsp;lang=&quot;EN&quot;&nbsp;style=&quot;font-size:9.0pt;font-family:Consolas;color:#333333&quot;&gt;}&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;align=&quot;left&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;text-align:left&quot;&gt;<br>
&lt;span&nbsp;lang=&quot;EN&quot;&nbsp;style=&quot;font-family:&quot;Helvetica&quot;,&quot;sans-serif&quot;;color:#333333&quot;&gt;label_oom:&lt;br&gt;<br>
if&nbsp;(ret&nbsp;==&nbsp;NULL)&nbsp;{&lt;br&gt;<br>
if&nbsp;(config_xmalloc&nbsp;&amp;&amp;&nbsp;opt_xmalloc)&nbsp;{&lt;br&gt;<br>
malloc_write(&quot;:&nbsp;Error&nbsp;in&nbsp;malloc():&nbsp;&quot;&lt;br&gt;<br>
&quot;out&nbsp;of&nbsp;memory\n&quot;);&lt;br&gt;<br>
abort();&lt;br&gt;<br>
}&lt;br&gt;<br>
set_errno(ENOMEM);&lt;br&gt;<br>
}&lt;br&gt;<br>
if&nbsp;(config_prof&nbsp;&amp;&amp;&nbsp;opt_prof&nbsp;&amp;&amp;&nbsp;ret&nbsp;!=&nbsp;NULL)&lt;br&gt;<br>
prof_malloc(ret,&nbsp;usize,&nbsp;cnt);&lt;br&gt;<br>
if&nbsp;(config_stats&nbsp;&amp;&amp;&nbsp;ret&nbsp;!=&nbsp;NULL)&nbsp;{&lt;br&gt;<br>
assert(usize&nbsp;==&nbsp;isalloc(ret,&nbsp;config_prof));&lt;br&gt;<br>
thread_allocated_tsd_get()-&gt;allocated&nbsp;&#43;=&nbsp;usize;&lt;br&gt;<br>
}&lt;br&gt;<br>
UTRACE(0,&nbsp;size,&nbsp;ret);&lt;br&gt;<br>
JEMALLOC_VALGRIND_MALLOC(ret&nbsp;!=&nbsp;NULL,&nbsp;ret,&nbsp;usize,&nbsp;false);&lt;br&gt;<br>
return&nbsp;(ret);&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;lang=&quot;EN-US&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
