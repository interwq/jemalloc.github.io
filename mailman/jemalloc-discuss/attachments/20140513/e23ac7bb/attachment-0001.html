<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=us-ascii&quot;&gt;<br>
&lt;style&nbsp;type=&quot;text/css&quot;&nbsp;style=&quot;display:none&quot;&gt;&lt;!--&nbsp;p&nbsp;{&nbsp;margin-top:&nbsp;0px;&nbsp;margin-bottom:&nbsp;0px;&nbsp;}--&gt;&lt;/style&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;dir=&quot;ltr&quot;&gt;<br>
&lt;div&nbsp;id=&quot;OWAFontStyleDivID&quot;&nbsp;style=&quot;font-size:12pt;color:#000000;background-color:#FFFFFF;font-family:Calibri,Arial,Helvetica,sans-serif;&quot;&gt;<br>
&lt;p&gt;Hello,&lt;/p&gt;<br>
&lt;p&gt;&lt;br&gt;<br>
&lt;/p&gt;<br>
&lt;p&gt;Some&nbsp;time&nbsp;ago&nbsp;I&nbsp;ported&nbsp;jemalloc&nbsp;to&nbsp;work&nbsp;on&nbsp;old&nbsp;systems&nbsp;still&nbsp;using&nbsp;LinuxThreads.&nbsp;See&nbsp;this&nbsp;thread:&nbsp;&lt;a&nbsp;href=&quot;http://jemalloc.net/mailman/jemalloc-discuss/2013-October/000646.html&quot;&nbsp;id=&quot;lnk281466&quot;&gt;http://jemalloc.net/mailman/jemalloc-discuss/2013-October/000646.html&lt;/a&gt;&lt;br&gt;<br>
&lt;/p&gt;<br>
&lt;p&gt;&lt;br&gt;<br>
&lt;/p&gt;<br>
&lt;p&gt;It&nbsp;seems&nbsp;that&nbsp;with&nbsp;LinuxThreads&nbsp;the&nbsp;fork()&nbsp;implementation&nbsp;will&nbsp;call&nbsp;free&nbsp;during&nbsp;fork,&nbsp;between&nbsp;jemalloc_prefork&nbsp;and&nbsp;jemalloc_postfork_child.&nbsp;This&nbsp;can&nbsp;sometimes&nbsp;(very&nbsp;rarely)&nbsp;hang&nbsp;in&nbsp;a&nbsp;call&nbsp;to&nbsp;system()&nbsp;with&nbsp;a&nbsp;stack&nbsp;like&nbsp;the&nbsp;following:&lt;br&gt;<br>
&lt;/p&gt;<br>
&lt;p&gt;&lt;br&gt;<br>
&lt;/p&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#0&nbsp;&nbsp;0x0fdd660c&nbsp;in&nbsp;__pthread_sigsuspend&nbsp;()&nbsp;from&nbsp;/lib/libpthread.so.0&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#1&nbsp;&nbsp;0x0fdd6344&nbsp;in&nbsp;__pthread_wait_for_restart_signal&nbsp;()&nbsp;from&nbsp;/lib/libpthread.so.0&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#2&nbsp;&nbsp;0x0fdd805c&nbsp;in&nbsp;__pthread_alt_lock&nbsp;()&nbsp;from&nbsp;/lib/libpthread.so.0&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#3&nbsp;&nbsp;0x0fdd4c74&nbsp;in&nbsp;pthread_mutex_lock&nbsp;()&nbsp;from&nbsp;/lib/libpthread.so.0&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#4&nbsp;&nbsp;0x0ff2a480&nbsp;in&nbsp;pthread_mutex_lock&nbsp;()&nbsp;from&nbsp;/lib/libc.so.6&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#5&nbsp;&nbsp;0x0ffc5bf0&nbsp;in&nbsp;malloc_mutex_lock&nbsp;(tbin=0x3082c020,&nbsp;binind=0,&nbsp;rem=0,&nbsp;tcache=0x3082c000)&nbsp;at&nbsp;../../src/jemalloc-3.0.0/include/jemalloc/internal/mutex.h:77&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#6&nbsp;&nbsp;tcache_bin_flush_small&nbsp;(tbin=0x3082c020,&nbsp;binind=0,&nbsp;rem=0,&nbsp;tcache=0x3082c000)&nbsp;at&nbsp;../../src/jemalloc-3.0.0/src/tcache.c:106&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#7&nbsp;&nbsp;0x0ffc64c0&nbsp;in&nbsp;tcache_event_hard&nbsp;(tcache=0x3082c000)&nbsp;at&nbsp;../../src/jemalloc-3.0.0/src/tcache.c:39&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;&lt;strong&gt;#8&nbsp;&nbsp;0x0ffa545c&nbsp;in&nbsp;tcache_event&nbsp;(ptr=0x3081e000)&nbsp;at&nbsp;../../src/jemalloc-3.0.0/include/jemalloc/internal/tcache.h:271&lt;/strong&gt;&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#9&nbsp;&nbsp;tcache_dalloc_large&nbsp;(ptr=0x3081e000)&nbsp;at&nbsp;../../src/jemalloc-3.0.0/include/jemalloc/internal/tcache.h:435&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#10&nbsp;arena_dalloc&nbsp;(ptr=0x3081e000)&nbsp;at&nbsp;../../src/jemalloc-3.0.0/include/jemalloc/internal/arena.h:966&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#11&nbsp;idalloc&nbsp;(ptr=0x3081e000)&nbsp;at&nbsp;include/jemalloc/internal/jemalloc_internal.h:840&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#12&nbsp;iqalloc&nbsp;(ptr=0x3081e000)&nbsp;at&nbsp;include/jemalloc/internal/jemalloc_internal.h:852&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#13&nbsp;free&nbsp;(ptr=0x3081e000)&nbsp;at&nbsp;../../src/jemalloc-3.0.0/src/jemalloc.c:1219&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#14&nbsp;0x0fdd6174&nbsp;in&nbsp;__pthread_reset_main_thread&nbsp;()&nbsp;from&nbsp;/lib/libpthread.so.0&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#15&nbsp;0x0fdd5288&nbsp;in&nbsp;__pthread_fork&nbsp;()&nbsp;from&nbsp;/lib/libpthread.so.0&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#16&nbsp;0x0feeadc4&nbsp;in&nbsp;fork&nbsp;()&nbsp;from&nbsp;/lib/libc.so.6&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#17&nbsp;0x0fe82eb0&nbsp;in&nbsp;do_system&nbsp;()&nbsp;from&nbsp;/lib/libc.so.6&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Consolas,&nbsp;monospace;&nbsp;font-size:&nbsp;11pt;&quot;&gt;#18&nbsp;0x0fe830c8&nbsp;in&nbsp;system&nbsp;()&nbsp;from&nbsp;/lib/libc.so.6&lt;/span&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;am&nbsp;not&nbsp;familiar&nbsp;with&nbsp;how&nbsp;jemalloc&nbsp;works&nbsp;internally&nbsp;but&nbsp;it&nbsp;seems&nbsp;that&nbsp;sometimes&nbsp;tcache_event&nbsp;will&nbsp;trigger&nbsp;some&nbsp;sort&nbsp;of&nbsp;GC.&nbsp;Sometimes&nbsp;(very&nbsp;rarely)&nbsp;this&nbsp;attempts&nbsp;to&nbsp;take&nbsp;a&nbsp;lock&nbsp;which&nbsp;is&nbsp;already&nbsp;taken&nbsp;inside&nbsp;jemalloc_prefork.&nbsp;This&nbsp;hangs&nbsp;because&nbsp;locks&nbsp;are<br>
&nbsp;not&nbsp;recursive&nbsp;by&nbsp;default.&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;was&nbsp;able&nbsp;to&nbsp;reproduce&nbsp;this&nbsp;in&nbsp;a&nbsp;standalone&nbsp;program.&nbsp;The&nbsp;issue&nbsp;seems&nbsp;to&nbsp;go&nbsp;away&nbsp;if&nbsp;I&nbsp;avoid&nbsp;the&nbsp;GC&nbsp;as&nbsp;in&nbsp;the&nbsp;attached&nbsp;patch.&nbsp;It&nbsp;seems&nbsp;like&nbsp;a&nbsp;horrible&nbsp;evil&nbsp;hack.&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;ul&gt;<br>
&lt;li&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12pt;&quot;&gt;Am&nbsp;I&nbsp;missing&nbsp;anything?&nbsp;&lt;span&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;Arial,&nbsp;Helvetica,&nbsp;sans-serif;&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;A&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;Arial,&nbsp;Helvetica,&nbsp;sans-serif;&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;re<br>
&nbsp;there&nbsp;any&nbsp;other&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;Arial,&nbsp;Helvetica,&nbsp;sans-serif;&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;p&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;Arial,&nbsp;Helvetica,&nbsp;sans-serif;&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;latforms&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;Arial,&nbsp;Helvetica,&nbsp;sans-serif;&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&gt;&nbsp;with<br>
&nbsp;this&nbsp;issue?&lt;/span&gt;&lt;/span&gt;&lt;/li&gt;&lt;li&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12pt;&quot;&gt;&#8203;Can&nbsp;you&nbsp;see&nbsp;something&nbsp;else&nbsp;going&nbsp;wrong&nbsp;because&nbsp;of&nbsp;free-during-fork?&nbsp;I&nbsp;could&nbsp;patch&nbsp;jemalloc&nbsp;to&nbsp;leak&nbsp;that&nbsp;memory.&nbsp;I&nbsp;only&nbsp;really&nbsp;care&nbsp;about&nbsp;system(),&nbsp;not&nbsp;other&nbsp;uses&nbsp;of&nbsp;fork().&lt;/span&gt;&lt;br&gt;<br>
&lt;/li&gt;&lt;li&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12pt;&quot;&gt;Can&nbsp;you&nbsp;think&nbsp;of&nbsp;a&nbsp;cleaner&nbsp;solution?&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;<br>
&lt;div&gt;The&nbsp;patch&nbsp;is&nbsp;on&nbsp;top&nbsp;of&nbsp;3.0.0&nbsp;so&nbsp;it&nbsp;won't&nbsp;apply&nbsp;cleanly.&nbsp;I&nbsp;tried&nbsp;to&nbsp;apply&nbsp;commits&nbsp;&lt;a&nbsp;href=&quot;https://github.com/jemalloc/jemalloc/commit/20f1fc95adb35ea63dc61f47f2b0ffbd37d39f32&quot;&gt;20f1fc95adb35ea63dc61f47f2b0ffbd37d39f32&lt;/a&gt;&nbsp;and&nbsp;&lt;a&nbsp;href=&quot;https://github.com/jemalloc/jemalloc/commit/b5225928fe106a7d809bd34e849abcd6941e93c7&quot;&gt;b5225928fe106a7d809bd34e849abcd6941e93c7&lt;/a&gt;<br>
&nbsp;but&nbsp;they&nbsp;did&nbsp;not&nbsp;help&nbsp;me.&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Regards,&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Leonard&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
