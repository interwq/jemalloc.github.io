<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Using&nbsp;the&nbsp;current&nbsp;version&nbsp;of&nbsp;the&nbsp;dev&nbsp;jemalloc,&nbsp;I&nbsp;found&nbsp;a&nbsp;case&nbsp;where&nbsp;jemalloc&nbsp;reuses&nbsp;a&nbsp;previously&nbsp;freed&nbsp;pointer.&nbsp;Specifically,&nbsp;the&nbsp;arena&nbsp;cache&nbsp;pointer&nbsp;can&nbsp;get&nbsp;freed,&nbsp;but&nbsp;reused.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;can&nbsp;happen&nbsp;when&nbsp;a&nbsp;thread&nbsp;is&nbsp;ending&nbsp;and&nbsp;the&nbsp;key&nbsp;destroy&nbsp;functions&nbsp;are&nbsp;being&nbsp;called.&nbsp;If&nbsp;the&nbsp;jemalloc&nbsp;key&nbsp;destroy&nbsp;function&nbsp;is&nbsp;called,&nbsp;the&nbsp;arena&nbsp;cache&nbsp;is&nbsp;destroyed.&nbsp;But&nbsp;if&nbsp;another&nbsp;key&nbsp;destroy&nbsp;function&nbsp;is&nbsp;called&nbsp;which&nbsp;allocates&nbsp;memory,&nbsp;the&nbsp;old&nbsp;arena&nbsp;cache&nbsp;pointer&nbsp;can&nbsp;be&nbsp;reused,&nbsp;and&nbsp;have&nbsp;the&nbsp;arena&nbsp;pointers&nbsp;written&nbsp;to&nbsp;it.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;think&nbsp;the&nbsp;fix&nbsp;is&nbsp;to&nbsp;change&nbsp;the&nbsp;arenas_cache_cleanup&nbsp;function&nbsp;to:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;void&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;arenas_cache_cleanup(tsd_t&nbsp;*tsd)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;{&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;arena_t&nbsp;**arenas_cache;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;arenas_cache&nbsp;=&nbsp;tsd_arenas_cache_get(tsd);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(arenas_cache&nbsp;!=&nbsp;NULL)&nbsp;{&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bool&nbsp;*arenas_cache_bypassp&nbsp;=&nbsp;tsd_arenas_cache_bypassp_get(tsd);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*arenas_cache_bypassp&nbsp;=&nbsp;true;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tsd_arenas_cache_set(tsd,&nbsp;NULL);&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;a0dalloc(arenas_cache);&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;believe&nbsp;the&nbsp;bypass&nbsp;has&nbsp;to&nbsp;be&nbsp;set&nbsp;so&nbsp;that&nbsp;another&nbsp;arena&nbsp;cache&nbsp;is&nbsp;not&nbsp;allocated&nbsp;since&nbsp;that&nbsp;memory&nbsp;would&nbsp;be&nbsp;leaked&nbsp;since&nbsp;there&nbsp;is&nbsp;not&nbsp;going&nbsp;to&nbsp;be&nbsp;another&nbsp;call&nbsp;to&nbsp;the&nbsp;arenas_cache_cleanup&nbsp;function.&nbsp;I&nbsp;think&nbsp;this&nbsp;is&nbsp;the&nbsp;only&nbsp;possible&nbsp;way&nbsp;something&nbsp;could&nbsp;be&nbsp;reused&nbsp;when&nbsp;an&nbsp;allocation&nbsp;is&nbsp;made&nbsp;after&nbsp;the&nbsp;jemalloc&nbsp;key&nbsp;destroy&nbsp;function&nbsp;is&nbsp;called,&nbsp;but&nbsp;I&nbsp;might&nbsp;have&nbsp;missed&nbsp;something.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;might&nbsp;be&nbsp;particular&nbsp;to&nbsp;the&nbsp;fact&nbsp;that&nbsp;my&nbsp;config&nbsp;uses&nbsp;pthread_key_create&nbsp;for&nbsp;the&nbsp;tsd&nbsp;data,&nbsp;but&nbsp;it&nbsp;might&nbsp;apply&nbsp;to&nbsp;other&nbsp;configs.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Does&nbsp;this&nbsp;solution&nbsp;seem&nbsp;reasonable?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Christopher&lt;/div&gt;&lt;/div&gt;<br>

</tt>
