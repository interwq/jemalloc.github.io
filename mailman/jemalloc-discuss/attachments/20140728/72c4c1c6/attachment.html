<tt>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;Also&nbsp;2^31&nbsp;==&nbsp;29,&nbsp;not&nbsp;1&lt;&lt;31&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;Bradley&nbsp;C&nbsp;Kuszmaul&nbsp;-&nbsp;via&nbsp;snartphone&lt;/p&gt;<br>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Jul&nbsp;28,&nbsp;2014&nbsp;7:04&nbsp;PM,&nbsp;&quot;meng&quot;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:xqmeng@gmail.com&quot;&gt;xqmeng@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&nbsp;type=&quot;attribution&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Yes,&nbsp;the&nbsp;address&nbsp;returned&nbsp;from&nbsp;the&nbsp;custom&nbsp;chunk_alloc()&nbsp;is&nbsp;got&nbsp;from&nbsp;mmap(0,2^31,...).&nbsp;Because&nbsp;2^31&nbsp;is&nbsp;a&nbsp;multiple&nbsp;of&nbsp;2^22&nbsp;(the&nbsp;default&nbsp;chunk&nbsp;size),&nbsp;it&nbsp;must&nbsp;be&nbsp;aligned&nbsp;with&nbsp;the&nbsp;chunk&nbsp;size.&lt;/div&gt;&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Below&nbsp;is&nbsp;a&nbsp;simplified&nbsp;version&nbsp;of&nbsp;my&nbsp;test&nbsp;program:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;void&nbsp;*space&nbsp;=&nbsp;NULL;&lt;/div&gt;&lt;div&gt;&lt;div&gt;static&nbsp; unsigned&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _arena;&lt;/div&gt;&lt;div&gt;static&nbsp; chunk_alloc_t&nbsp; &nbsp; &nbsp; &nbsp; *_alloc;&lt;/div&gt;&lt;div&gt;static&nbsp; chunk_dalloc_t&nbsp; &nbsp; &nbsp; *_dalloc;&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;static&nbsp;void&nbsp;*_chunk_alloc(size_t,&nbsp;size_t,&nbsp;bool&nbsp;*,&nbsp;unsigned);&lt;/div&gt;&lt;div&gt;static&nbsp;bool&nbsp;_chunk_dalloc(void&nbsp;*,&nbsp;size_t,&nbsp;unsigned);&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;void&nbsp;*&nbsp;_chunk_alloc(size_t&nbsp;size,&nbsp;size_t&nbsp;alignment,&nbsp;bool&nbsp;*zero,&nbsp;unsigned&nbsp;arena_ind)&lt;br&gt;&lt;/div&gt;&lt;div&gt;<br>
&lt;div&gt;{&lt;/div&gt;&lt;div&gt; &nbsp;return&nbsp;space;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;bool&nbsp;_chunk_dalloc(void&nbsp;*chunk,&nbsp;size_t&nbsp;size,&nbsp;unsigned&nbsp;arena_ind)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;/div&gt;&lt;div&gt; &nbsp;return&nbsp;true;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;div&gt;int&nbsp;main(void)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt; &nbsp;space&nbsp;=&nbsp;mmap&nbsp;(NULL,&nbsp;2^31,&nbsp;PROT_READ&nbsp;|&nbsp;PROT_WRITE,&nbsp;MAP_SHARED&nbsp;|&nbsp;MAP_ANONYMOUS,&nbsp;-1,&nbsp;0);&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt; &nbsp;assert&nbsp;(space&nbsp;!=&nbsp;(void&nbsp;*)&nbsp;-1);&lt;/div&gt;&lt;/div&gt;&lt;div&gt;  &lt;br&gt;&lt;/div&gt;&lt;div&gt;<br>
 &nbsp;size_t&nbsp;sz&nbsp;=&nbsp;sizeof(_arena);&lt;/div&gt;<br>
&lt;div&gt; &nbsp;int&nbsp;ret&nbsp;=&nbsp;mallctl(&quot;arenas.extend&quot;,&nbsp;&amp;_arena,&nbsp;&amp;sz,&nbsp;NULL,&nbsp;0);&lt;/div&gt;&lt;div&gt; &nbsp;assert&nbsp;(ret&nbsp;==&nbsp;0);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;sz&nbsp;=&nbsp;sizeof(_alloc);&lt;/div&gt;&lt;div&gt; &nbsp;char&nbsp;path[128];&lt;/div&gt;&lt;div&gt; &nbsp;snprintf(path,&nbsp;sizeof(path),&nbsp;&quot;arena.%u.chunk.alloc&quot;,&nbsp;_arena);&lt;/div&gt;<br>
<br>
&lt;div&gt; &nbsp;chunk_alloc_t&nbsp;*alloc&nbsp;=&nbsp;_chunk_alloc;&lt;/div&gt;&lt;div&gt; &nbsp;ret&nbsp;=&nbsp;mallctl(path,&nbsp;(void*)&amp;_alloc,&nbsp;&amp;sz,&nbsp;(void*)&amp;alloc,&nbsp;sizeof(alloc));&lt;/div&gt;&lt;div&gt; &nbsp;assert&nbsp;(ret&nbsp;==&nbsp;0);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;snprintf(path,&nbsp;sizeof(path),&nbsp;&quot;arena.%u.chunk.dalloc&quot;,&nbsp;_arena);&lt;/div&gt;<br>
<br>
&lt;div&gt; &nbsp;chunk_dalloc_t&nbsp;*dalloc&nbsp;=&nbsp;_chunk_dalloc;&lt;/div&gt;&lt;div&gt; &nbsp;ret&nbsp;=&nbsp;mallctl(path,&nbsp;(void*)&amp;_dalloc,&nbsp;&amp;sz,&nbsp;(void*)&amp;dalloc,&nbsp;sizeof(dalloc));&lt;/div&gt;&lt;div&gt; &nbsp;assert&nbsp;(ret&nbsp;==&nbsp;0);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;void&nbsp;*p&nbsp;=&nbsp;mallocx(1024,&nbsp;MALLOCX_ARENA(_arena));&lt;/div&gt;<br>
<br>
&lt;div&gt; &nbsp;assert&nbsp;(p&nbsp;!=&nbsp;0);&lt;/div&gt;&lt;div&gt; &nbsp;dallocx(p,&nbsp;MALLOCX_ARENA(_arena));&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;//unmap&nbsp;space&lt;/div&gt;&lt;div&gt; &nbsp;return&nbsp;1;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;seg.&nbsp;fault&nbsp;occurs&nbsp;in&nbsp;mallocx,&nbsp;and&nbsp;here&nbsp;is&nbsp;the&nbsp;stack&nbsp;frame&nbsp;in&nbsp;GDB:&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;div&gt;#0&nbsp; 0x00007ffff7d6b7a2&nbsp;in&nbsp;je_arena_mapbitsp_write&nbsp;(mapbits=4,&nbsp;mapbitsp=0x7ffff7cb0008)&nbsp;at&nbsp;include/jemalloc/internal/arena.h:774&lt;/div&gt;&lt;div&gt;#1&nbsp; je_arena_mapbits_unzeroed_set&nbsp;(unzeroed=4,&nbsp;pageind=345,&nbsp;chunk=0x7ffff7cae000)&nbsp;at&nbsp;include/jemalloc/internal/arena.h:852&lt;/div&gt;<br>
<br>
&lt;div&gt;#2&nbsp; arena_chunk_init_hard&nbsp;(arena=0x7ffff7822140)&nbsp;at&nbsp;src/arena.c:662&lt;/div&gt;&lt;div&gt;#3&nbsp; 0x00007ffff7d6bea8&nbsp;in&nbsp;arena_chunk_alloc&nbsp;(arena=0x7ffff7822140)&nbsp;at&nbsp;src/arena.c:689&lt;/div&gt;&lt;div&gt;#4&nbsp; 0x00007ffff7d6ce9b&nbsp;in&nbsp;arena_run_alloc_small&nbsp;(arena=0x7ffff7822140,&nbsp;size=65536,&nbsp;binind=20)&nbsp;at&nbsp;src/arena.c:854&lt;/div&gt;<br>
<br>
&lt;div&gt;#5&nbsp; 0x00007ffff7d74852&nbsp;in&nbsp;arena_bin_nonfull_run_get&nbsp;(arena=0x7ffff7822140,&nbsp;bin=0x7ffff7822e70)&nbsp;at&nbsp;src/arena.c:1470&lt;/div&gt;&lt;div&gt;#6&nbsp; 0x00007ffff7d749aa&nbsp;in&nbsp;arena_bin_malloc_hard&nbsp;(arena=0x7ffff7822140,&nbsp;bin=0x7ffff7822e70)&nbsp;at&nbsp;src/arena.c:1516&lt;/div&gt;<br>
<br>
&lt;div&gt;#7&nbsp; 0x00007ffff7d7558a&nbsp;in&nbsp;je_arena_malloc_small&nbsp;(arena=0x7ffff7822140,&nbsp;size=1024,&nbsp;zero=false)&nbsp;at&nbsp;src/arena.c:1713&lt;/div&gt;&lt;div&gt;#8&nbsp; 0x00007ffff7d17121&nbsp;in&nbsp;je_arena_malloc&nbsp;(try_tcache=false,&nbsp;zero=false,&nbsp;size=1024,&nbsp;arena=0x7ffff7822140)&nbsp;at&nbsp;include/jemalloc/internal/arena.h:1076&lt;/div&gt;<br>
<br>
&lt;div&gt;#9&nbsp; je_imalloct&nbsp;(arena=0x7ffff7822140,&nbsp;try_tcache=false,&nbsp;size=1024)&nbsp;at&nbsp;include/jemalloc/internal/jemalloc_internal.h:647&lt;/div&gt;&lt;div&gt;#10&nbsp;imallocx&nbsp;(arena=0x7ffff7822140,&nbsp;try_tcache=false,&nbsp;zero=false,&nbsp;alignment=0,&nbsp;usize=1024)&nbsp;at&nbsp;src/jemalloc.c:1377&lt;/div&gt;<br>
<br>
&lt;div&gt;#11&nbsp;mallocx&nbsp;(size=1024,&nbsp;flags=512)&nbsp;at&nbsp;src/jemalloc.c:1456&lt;/div&gt;&lt;div&gt;#12&nbsp;0x0000000000400c06&nbsp;in&nbsp;main&nbsp;()&nbsp;at&nbsp;test_jemalloc.c:102&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;<br>
<br>
&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Jul&nbsp;28,&nbsp;2014&nbsp;at&nbsp;5:52&nbsp;PM,&nbsp;Jason&nbsp;Evans&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:jasone@canonware.com&quot;&nbsp;target=&quot;_blank&quot;&gt;jasone@canonware.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
<br>
&lt;div&gt;&lt;div&gt;On&nbsp;Jul&nbsp;28,&nbsp;2014,&nbsp;at&nbsp;2:17&nbsp;PM,&nbsp;meng&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:xqmeng@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;xqmeng@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;used&nbsp;the&nbsp;new&nbsp;chunk&nbsp;allocator&nbsp;feature&nbsp;to&nbsp;allocate&nbsp;memory&nbsp;from&nbsp;a&nbsp;fixed&nbsp;2G&nbsp;memory&nbsp;region.&nbsp;Nevertheless,&nbsp;I&nbsp;got&nbsp;a&nbsp;seg.&nbsp;fault.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;The&nbsp;flow&nbsp;of&nbsp;my&nbsp;code&nbsp;is&nbsp;as&nbsp;following:&nbsp; I&nbsp;first&nbsp;use&nbsp;&quot;arenas.extend&quot;&nbsp;mallctl&nbsp;to&nbsp;create&nbsp;a&nbsp;custom&nbsp;arena.&nbsp;Then&nbsp;I&nbsp;defined&nbsp;custom&nbsp;chunk_alloc()&nbsp;and&nbsp;chunk_dalloc()&nbsp;on&nbsp;this&nbsp;arena.&nbsp;In&nbsp;the&nbsp;initialization&nbsp;phase&nbsp;of&nbsp;my&nbsp;code,&nbsp;I&nbsp;use&nbsp;mmap()&nbsp;to&nbsp;reserve&nbsp;a&nbsp;memory&nbsp;region&nbsp;of&nbsp;size&nbsp;2^32.&nbsp;In&nbsp;the&nbsp;custom&nbsp;chunk_alloc(),&nbsp;I&nbsp;return&nbsp;the&nbsp;pointer&nbsp;of&nbsp;the&nbsp;2^32B&nbsp;memory&nbsp;region.&nbsp;Because&nbsp;lg_chunk&nbsp;is&nbsp;2^22,&nbsp;I&nbsp;thought&nbsp;this&nbsp;should&nbsp;be&nbsp;fine.&nbsp;But&nbsp;the&nbsp;program&nbsp;ran&nbsp;into&nbsp;seg.&nbsp;fault&nbsp;within&nbsp; arena_mapbits_unzeroed_set()&nbsp;called&nbsp;by&nbsp;arena_chunk_init_hard().&nbsp; On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;if&nbsp;the&nbsp;mmap()&nbsp;reserved&nbsp;a&nbsp;memory&nbsp;region&nbsp;of&nbsp;size&nbsp;2^22,&nbsp;everything&nbsp;works&nbsp;fine.&lt;br&gt;<br>
<br>
<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;My&nbsp;question&nbsp;is:&nbsp;why&nbsp;does&nbsp;the&nbsp;custom&nbsp;chunk_alloc()&nbsp;always&nbsp;expect&nbsp;a&nbsp;memory&nbsp;block&nbsp;returned&nbsp;from&nbsp;mmap()/malloc()&nbsp;with&nbsp;the&nbsp;requested&nbsp;size&nbsp;equal&nbsp;to&nbsp;lg_chunk?&nbsp;I&nbsp;can&#39;t&nbsp;figure&nbsp;out&nbsp;what&nbsp;wrong&nbsp;it&nbsp;could&nbsp;be&nbsp;if&nbsp;the&nbsp;returned&nbsp;block&nbsp;is&nbsp;a&nbsp;multiple&nbsp;of&nbsp;lg_chunk&lt;br&gt;<br>
<br>
<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;B.T.W.&nbsp;My&nbsp;code&nbsp;only&nbsp;uses&nbsp;mallocx()&nbsp;for&nbsp;a&nbsp;single&nbsp;1024B&nbsp;buffer&nbsp;from&nbsp;the&nbsp;custom.&nbsp;Memory&nbsp;alignment&nbsp;problem&nbsp;shouldn&#39;t&nbsp;exist.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;Is&nbsp;the&nbsp;address&nbsp;you&#39;re&nbsp;returning&nbsp;from&nbsp;the&nbsp;custom&nbsp;chunk_alloc()&nbsp;aligned&nbsp;at&nbsp;a&nbsp;multiple&nbsp;of&nbsp;the&nbsp;chunk&nbsp;size?&lt;br&gt;<br>
&lt;span&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
Jason&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;Best&lt;br&gt;-Xiaoqiao<br>
&lt;/div&gt;<br>
&lt;br&gt;_______________________________________________&lt;br&gt;<br>
jemalloc-discuss&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:jemalloc-discuss@canonware.com&quot;&gt;jemalloc-discuss@canonware.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://www.canonware.com/mailman/listinfo/jemalloc-discuss&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.canonware.com/mailman/listinfo/jemalloc-discuss&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
