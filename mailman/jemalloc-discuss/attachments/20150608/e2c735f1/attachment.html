<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Recently,&nbsp;it&nbsp;appears&nbsp;that&nbsp;there&nbsp;was&nbsp;a&nbsp;bug&nbsp;introduced&nbsp;in&nbsp;chunk&nbsp;allocation.&nbsp;The&nbsp;bug&nbsp;is&nbsp;exposed&nbsp;by&nbsp;this&nbsp;small&nbsp;snippet&nbsp;of&nbsp;code:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp;void*&nbsp;mem&nbsp;=&nbsp;malloc(128*1024*1024);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp;printf(&quot;mem&nbsp;address&nbsp;%p\n&quot;,&nbsp;mem);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp;free(mem);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp;void*&nbsp;large_alloc&nbsp;=&nbsp;malloc(0x80000081UL);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace,monospace&quot;&gt; &nbsp;printf(&quot;large&nbsp;mem&nbsp;%p\n&quot;,&nbsp;large_alloc);&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp;free(large_alloc);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;looks&nbsp;like&nbsp;the&nbsp;bug&nbsp;is&nbsp;in&nbsp;the&nbsp;chunk_recycle&nbsp;code,&nbsp;in&nbsp;this&nbsp;piece&nbsp;of&nbsp;code:&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(new_addr&nbsp;!=&nbsp;NULL)&nbsp;{&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;extent_node_t&nbsp;key;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;extent_node_init(&amp;key,&nbsp;arena,&nbsp;new_addr,&nbsp;alloc_size,&nbsp;false);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node&nbsp;=&nbsp;extent_tree_ad_search(chunks_ad,&nbsp;&amp;key);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;}&nbsp;else&nbsp;{&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node&nbsp;=&nbsp;chunk_first_fit(arena,&nbsp;chunks_szad,&nbsp;chunks_ad,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;alloc_size);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(node&nbsp;==&nbsp;NULL&nbsp;||&nbsp;(new_addr&nbsp;!=&nbsp;NULL&nbsp;&amp;&amp;&nbsp;extent_node_size_get(node)&nbsp;&lt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;size))&nbsp;{&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;malloc_mutex_unlock(&amp;arena-&gt;chunks_mtx);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;(NULL);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;new_addr&nbsp;==&nbsp;NULL,&nbsp;so&nbsp;the&nbsp;size&nbsp;check&nbsp;is&nbsp;not&nbsp;performed.&nbsp;In&nbsp;my&nbsp;testing,&nbsp;removing&nbsp;the&nbsp;new_addr&nbsp;!=&nbsp;NULL&nbsp;check&nbsp;fixes&nbsp;the&nbsp;problem,&nbsp;but&nbsp;I&nbsp;don&#39;t&nbsp;know&nbsp;if&nbsp;that&#39;s&nbsp;the&nbsp;correct&nbsp;change.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;first&nbsp;allocation&nbsp;after&nbsp;the&nbsp;free&nbsp;shows&nbsp;the&nbsp;problem,&nbsp;if&nbsp;you&nbsp;try&nbsp;and&nbsp;use&nbsp;the&nbsp;whole&nbsp;memory&nbsp;allocation&nbsp;it&nbsp;might&nbsp;segfault,&nbsp;or&nbsp;let&nbsp;you&nbsp;scribble&nbsp;all&nbsp;over&nbsp;someone&nbsp;else&#39;s&nbsp;memory.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Christopher&nbsp;Ferris&lt;/div&gt;&lt;div&gt;(&lt;a&nbsp;href=&quot;mailto:cferris@google.com&quot;&gt;cferris@google.com&lt;/a&gt;)&lt;/div&gt;&lt;/div&gt;<br>

</tt>
