<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;div&gt;&lt;div&gt;On&nbsp;May&nbsp;25,&nbsp;2012,&nbsp;at&nbsp;2:02&nbsp;AM,&nbsp;Jokea&nbsp;wrote:&lt;/div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&nbsp;bgcolor=&quot;#FFFFFF&quot;&nbsp;text=&quot;#000000&quot;&gt;&lt;div&nbsp;class=&quot;moz-text-html&quot;&gt;&lt;font&nbsp;face=&quot;Î¢ÈíÑÅºÚ&quot;&gt;I've&nbsp;found&nbsp;that&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;forked&nbsp;child&nbsp;runs&nbsp;into&nbsp;dead&nbsp;lock&nbsp;in&nbsp;a&nbsp;multithreaded&nbsp;application.&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;jemalloc&nbsp;calls&nbsp;pthread_atfork()&nbsp;during&nbsp;initialization,&nbsp;but&nbsp;the&nbsp;test&nbsp;program&nbsp;does&nbsp;no&nbsp;allocation&nbsp;in&nbsp;the&nbsp;main&nbsp;thread&nbsp;before&nbsp;forking,&nbsp;and&nbsp;it&nbsp;launches&nbsp;threads&nbsp;that&nbsp;race&nbsp;with&nbsp;it.&nbsp;&nbsp;It&nbsp;appears&nbsp;that&nbsp;one&nbsp;of&nbsp;those&nbsp;threads&nbsp;gets&nbsp;part&nbsp;way&nbsp;through&nbsp;allocator&nbsp;initialization&nbsp;before&nbsp;the&nbsp;fork&nbsp;occurs,&nbsp;which&nbsp;leaves&nbsp;the&nbsp;allocator&nbsp;in&nbsp;an&nbsp;inconsistent&nbsp;state&nbsp;(init_lock&nbsp;locked,&nbsp;but&nbsp;initialization&nbsp;incomplete).&nbsp;&nbsp;The&nbsp;simple&nbsp;workaround&nbsp;is&nbsp;to&nbsp;allocate&nbsp;something&nbsp;before&nbsp;forking.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;A&nbsp;general&nbsp;fix&nbsp;in&nbsp;jemalloc&nbsp;is&nbsp;messy&nbsp;at&nbsp;best.&nbsp;&nbsp;The&nbsp;possibilities&nbsp;that&nbsp;come&nbsp;to&nbsp;mind&nbsp;are&nbsp;1)&nbsp;intercepting&nbsp;pthread_create()&nbsp;(or&nbsp;all&nbsp;fork-like&nbsp;system&nbsp;calls)&nbsp;much&nbsp;as&nbsp;the&nbsp;lazy&nbsp;locking&nbsp;code&nbsp;in&nbsp;mutex.c&nbsp;does&nbsp;and&nbsp;forcing&nbsp;allocator&nbsp;initialization,&nbsp;or&nbsp;2)&nbsp;using&nbsp;a&nbsp;library&nbsp;initializer&nbsp;(function&nbsp;specified&nbsp;via&nbsp;compiler&nbsp;attribute&nbsp;to&nbsp;be&nbsp;run&nbsp;during&nbsp;library&nbsp;load)&nbsp;to&nbsp;force&nbsp;allocator&nbsp;initialization.&nbsp;&nbsp;Both&nbsp;of&nbsp;these&nbsp;approaches&nbsp;are&nbsp;somewhat&nbsp;fragile;&nbsp;dlsym(RTLD_NEXT,&nbsp;¡­)&nbsp;can&nbsp;break&nbsp;if&nbsp;other&nbsp;libraries&nbsp;play&nbsp;similar&nbsp;games,&nbsp;and&nbsp;library&nbsp;initializers&nbsp;don't&nbsp;run&nbsp;early&nbsp;enough&nbsp;to&nbsp;prevent&nbsp;all&nbsp;possible&nbsp;failures.&nbsp;&nbsp;In&nbsp;any&nbsp;case,&nbsp;I'll&nbsp;make&nbsp;a&nbsp;note&nbsp;to&nbsp;experiment&nbsp;with&nbsp;(2).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;Jason&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
