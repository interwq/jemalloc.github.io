<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=us-ascii&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;On&nbsp;Oct&nbsp;6,&nbsp;2014,&nbsp;at&nbsp;10:59&nbsp;PM,&nbsp;Marcin&nbsp;Zalewski&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:marcin.zalewski@gmail.com&quot;&gt;marcin.zalewski@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;I&nbsp;am&nbsp;using&nbsp;the&nbsp;jemalloc&nbsp;from&nbsp;4dcf04bfc03b9e9eb50015a8fc8735de28c23090&nbsp;on&nbsp;a&nbsp;Cray&nbsp;system.&nbsp;We&nbsp;use&nbsp;jemalloc&nbsp;for&nbsp;all&nbsp;allocations,&nbsp;and&nbsp;I&nbsp;get&nbsp;a&nbsp;strange&nbsp;issue&nbsp;with&nbsp;Crays&nbsp;hugepages&nbsp;implementation.&nbsp;When&nbsp;I&nbsp;do&nbsp;not&nbsp;use&nbsp;the&nbsp;Cray&nbsp;hugepages&nbsp;module,&nbsp;my&nbsp;code&nbsp;runs&nbsp;fine.&nbsp;However,&nbsp;when&nbsp;I&nbsp;load&nbsp;hugepages64M,&nbsp;I&nbsp;get&nbsp;the&nbsp;following&nbsp;segmentation&nbsp;fault:&lt;br&gt;&lt;br&gt;Program&nbsp;received&nbsp;signal&nbsp;SIGSEGV,&nbsp;Segmentation&nbsp;fault.&lt;br&gt;je_chunk_alloc_default&nbsp;(size=2048,&nbsp;alignment=0,&nbsp;zero=0x7fffffffa96f,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;arena_ind=0)&nbsp;at&nbsp;chunk.c:254&lt;br&gt;254&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(chunk_alloc_core(size,&nbsp;alignment,&nbsp;false,&nbsp;zero,&lt;br&gt;(gdb)&nbsp;bt&lt;br&gt;#0&nbsp;&nbsp;je_chunk_alloc_default&nbsp;(size=2048,&nbsp;alignment=0,&nbsp;zero=0x7fffffffa96f,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;arena_ind=0)&nbsp;at&nbsp;chunk.c:254&lt;br&gt;#1&nbsp;&nbsp;0x000000002001586f&nbsp;in&nbsp;je_huge_palloc&nbsp;(tsd=0x2aaab02092d0,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;arena=&lt;optimized&nbsp;out&gt;,&nbsp;size=size@entry=2048,&nbsp;alignment=0,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;zero=zero@entry=true)&nbsp;at&nbsp;huge.c:50&lt;br&gt;#2&nbsp;&nbsp;0x0000000020015908&nbsp;in&nbsp;je_huge_malloc&nbsp;(tsd=&lt;optimized&nbsp;out&gt;,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;arena=&lt;optimized&nbsp;out&gt;,&nbsp;size=size@entry=2048,&nbsp;zero=zero@entry=true)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;huge.c:19&lt;br&gt;#3&nbsp;&nbsp;0x0000000020018c90&nbsp;in&nbsp;je_icalloct&nbsp;(arena=&lt;optimized&nbsp;out&gt;,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;try_tcache=&lt;optimized&nbsp;out&gt;,&nbsp;size=2048,&nbsp;tsd=&lt;optimized&nbsp;out&gt;)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;../../../contrib/jemalloc/include/jemalloc/internal/jemalloc_internal.h:662&lt;br&gt;#4&nbsp;&nbsp;imallocx_flags&nbsp;(arena=&lt;optimized&nbsp;out&gt;,&nbsp;try_tcache=&lt;optimized&nbsp;out&gt;,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;zero=true,&nbsp;alignment=0,&nbsp;usize=2048,&nbsp;tsd=&lt;optimized&nbsp;out&gt;)&nbsp;at&nbsp;jemalloc.c:1450&lt;br&gt;#5&nbsp;&nbsp;imallocx_no_prof&nbsp;(usize=&lt;synthetic&nbsp;pointer&gt;,&nbsp;flags=&lt;optimized&nbsp;out&gt;,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;size=&lt;optimized&nbsp;out&gt;,&nbsp;tsd=&lt;optimized&nbsp;out&gt;)&nbsp;at&nbsp;jemalloc.c:1531&lt;br&gt;#6&nbsp;&nbsp;libxxx_mallocx&nbsp;(size=&lt;optimized&nbsp;out&gt;,&nbsp;flags=&lt;optimized&nbsp;out&gt;)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;jemalloc.c:1550&lt;br&gt;#7&nbsp;&nbsp;0x00002aaaaf6b9445&nbsp;in&nbsp;register_printf_type&nbsp;()&nbsp;from&nbsp;/lib64/libc.so.6&lt;br&gt;#8&nbsp;&nbsp;0x00002aaaabf019c0&nbsp;in&nbsp;register_printf_flt128&nbsp;()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;../../../cray-gcc-4.9.0/libquadmath/printf/quadmath-printf.c:390&lt;br&gt;#9&nbsp;&nbsp;0x00002aaaabf09de6&nbsp;in&nbsp;__do_global_ctors_aux&nbsp;()&lt;br&gt;&nbsp;&nbsp;&nbsp;from&nbsp;/opt/gcc/4.9.0/snos/lib64/libquadmath.so.0&lt;br&gt;#10&nbsp;0x00002aaaabee51fb&nbsp;in&nbsp;_init&nbsp;()&lt;br&gt;&nbsp;&nbsp;&nbsp;from&nbsp;/opt/gcc/4.9.0/snos/lib64/libquadmath.so.0&lt;br&gt;#11&nbsp;0x00007fffffffaaf8&nbsp;in&nbsp;??&nbsp;()&lt;br&gt;#12&nbsp;0x00002aaaaaab91b8&nbsp;in&nbsp;call_init&nbsp;()&nbsp;from&nbsp;/lib64/ld-linux-x86-64.so.2&lt;br&gt;#13&nbsp;0x00002aaaaaab92e7&nbsp;in&nbsp;_dl_init_internal&nbsp;()&nbsp;from&nbsp;/lib64/ld-linux-x86-64.so.2&lt;br&gt;#14&nbsp;0x00002aaaaaaabb3a&nbsp;in&nbsp;_dl_start_user&nbsp;()&nbsp;from&nbsp;/lib64/ld-linux-x86-64.so.2&lt;br&gt;#15&nbsp;0x0000000000000001&nbsp;in&nbsp;??&nbsp;()&lt;br&gt;#16&nbsp;0x00007fffffffb209&nbsp;in&nbsp;??&nbsp;()&lt;br&gt;#17&nbsp;0x0000000000000000&nbsp;in&nbsp;??&nbsp;()&lt;br&gt;&lt;br&gt;&lt;/div&gt;I&nbsp;know&nbsp;that&nbsp;this&nbsp;is&nbsp;not&nbsp;very&nbsp;much&nbsp;info&nbsp;to&nbsp;go&nbsp;on,&nbsp;but&nbsp;I&nbsp;wonder&nbsp;if&nbsp;it&nbsp;rings&nbsp;a&nbsp;bell&nbsp;for&nbsp;someone&nbsp;immediately.&nbsp;As&nbsp;far&nbsp;as&nbsp;I&nbsp;can&nbsp;understand,&nbsp;the&nbsp;Cray&nbsp;hugepages&nbsp;module&nbsp;silently&nbsp;changes&nbsp;all&nbsp;the&nbsp;pages&nbsp;to&nbsp;hugepages&nbsp;of&nbsp;a&nbsp;chosen&nbsp;size:&lt;br&gt;&lt;br&gt;&lt;a&nbsp;href=&quot;http://www.nersc.gov/users/computational-systems/hopper/programming/tuning-options/&quot;&gt;http://www.nersc.gov/users/computational-systems/hopper/programming/tuning-options/&lt;/a&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;What&nbsp;could&nbsp;be&nbsp;an&nbsp;obvious&nbsp;reason&nbsp;to&nbsp;cause&nbsp;the&nbsp;segmentation&nbsp;fault&nbsp;on&nbsp;that&nbsp;line?&nbsp;The&nbsp;line&nbsp;in&nbsp;question&nbsp;is&nbsp;this:&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(chunk_alloc_core(size,&nbsp;alignment,&nbsp;false,&nbsp;zero,&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arenas[arena_ind]-&gt;dss_prec));&lt;br&gt;&lt;br&gt;&lt;/div&gt;It&nbsp;seems&nbsp;that&nbsp;&quot;arenas&quot;&nbsp;is&nbsp;not&nbsp;properly&nbsp;initialized,&nbsp;but&nbsp;only&nbsp;with&nbsp;hugepages.&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;I've&nbsp;been&nbsp;staring&nbsp;at&nbsp;this&nbsp;for&nbsp;a&nbsp;while,&nbsp;but&nbsp;can't&nbsp;come&nbsp;up&nbsp;with&nbsp;any&nbsp;conclusive&nbsp;picture&nbsp;of&nbsp;what's&nbsp;going&nbsp;on.&nbsp;&nbsp;Part&nbsp;of&nbsp;the&nbsp;problem&nbsp;is&nbsp;that&nbsp;there&nbsp;are&nbsp;two&nbsp;frames&nbsp;missing&nbsp;from&nbsp;the&nbsp;backtrace,&nbsp;and&nbsp;the&nbsp;reported&nbsp;function&nbsp;arguments&nbsp;are&nbsp;clearly&nbsp;fictional.&nbsp;&nbsp;Here's&nbsp;what&nbsp;the&nbsp;first&nbsp;several&nbsp;frames&nbsp;of&nbsp;the&nbsp;backtrace&nbsp;should&nbsp;look&nbsp;like:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;je_chunk_alloc_default(...)&lt;/div&gt;&lt;div&gt;&gt;&gt;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;je_chunk_alloc_arena(...)&lt;/div&gt;&lt;div&gt;&gt;&gt;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;je_arena_chunk_alloc_huge(...)&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;je_huge_palloc(...)&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&lt;/span&gt;je_huge_malloc(...)&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&lt;/span&gt;je_icalloct(...)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;calls&nbsp;are&nbsp;being&nbsp;made&nbsp;through&nbsp;function&nbsp;pointers,&nbsp;so&nbsp;I&nbsp;don't&nbsp;think&nbsp;it's&nbsp;possible&nbsp;for&nbsp;inlining&nbsp;to&nbsp;explain&nbsp;the&nbsp;omissions.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;mystery&nbsp;is&nbsp;how&nbsp;arenas[arena_ind]&nbsp;could&nbsp;possibly&nbsp;be&nbsp;NULL,&nbsp;given&nbsp;that&nbsp;arena_chunk_alloc_huge()&nbsp;is&nbsp;reading&nbsp;arena-&gt;ind&nbsp;in&nbsp;order&nbsp;to&nbsp;pass&nbsp;the&nbsp;arena&nbsp;index&nbsp;to&nbsp;chunk_alloc_arena().&nbsp;&nbsp;In&nbsp;fact&nbsp;it's&nbsp;unsafe&nbsp;to&nbsp;read&nbsp;arenas[arena_ind]&nbsp;because&nbsp;the&nbsp;arenas.extend&nbsp;mallctl&nbsp;can&nbsp;write&nbsp;to&nbsp;the&nbsp;arenas&nbsp;pointer,&nbsp;but&nbsp;in&nbsp;order&nbsp;for&nbsp;that&nbsp;to&nbsp;be&nbsp;causing&nbsp;this&nbsp;crash,&nbsp;there&nbsp;would&nbsp;need&nbsp;to&nbsp;be&nbsp;another&nbsp;thread&nbsp;creating&nbsp;a&nbsp;new&nbsp;arena,&nbsp;and&nbsp;it&nbsp;would&nbsp;be&nbsp;a&nbsp;small&nbsp;race&nbsp;window.&nbsp;&nbsp;(I'll&nbsp;fix&nbsp;the&nbsp;bug&nbsp;though!)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;One&nbsp;random&nbsp;observation&nbsp;is&nbsp;that&nbsp;this&nbsp;crash&nbsp;is&nbsp;happening&nbsp;very&nbsp;early&nbsp;during&nbsp;execution,&nbsp;due&nbsp;to&nbsp;a&nbsp;library&nbsp;initializer&nbsp;running&nbsp;before&nbsp;entry&nbsp;into&nbsp;main().&nbsp;&nbsp;It&nbsp;appears&nbsp;though&nbsp;that&nbsp;jemalloc&nbsp;has&nbsp;successfully&nbsp;bootstrapped&nbsp;itself&nbsp;by&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;crash;&nbsp;otherwise&nbsp;malloc_init()&nbsp;would&nbsp;have&nbsp;failed&nbsp;in&nbsp;mallocx().&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is&nbsp;register_printf_type()&nbsp;really&nbsp;calling&nbsp;mallocx()?&nbsp;&nbsp;I'd&nbsp;expect&nbsp;it&nbsp;to&nbsp;call&nbsp;malloc()&nbsp;or&nbsp;calloc(),&nbsp;unless&nbsp;jemalloc&nbsp;is&nbsp;pretty&nbsp;deeply&nbsp;integrated.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Are&nbsp;you&nbsp;able&nbsp;to&nbsp;reproduce&nbsp;this&nbsp;crash&nbsp;with&nbsp;a&nbsp;debug&nbsp;build&nbsp;of&nbsp;jemalloc&nbsp;(hopefully&nbsp;with&nbsp;more&nbsp;accurate&nbsp;backtrace)?&nbsp;&nbsp;I'm&nbsp;concerned&nbsp;that&nbsp;this&nbsp;could&nbsp;be&nbsp;a&nbsp;bug&nbsp;in&nbsp;jemalloc,&nbsp;but&nbsp;I&nbsp;can't&nbsp;find&nbsp;a&nbsp;code&nbsp;path&nbsp;that&nbsp;could&nbsp;cause&nbsp;this.&nbsp;&nbsp;In&nbsp;the&nbsp;absence&nbsp;of&nbsp;additional&nbsp;evidence,&nbsp;my&nbsp;first&nbsp;guess&nbsp;is&nbsp;that&nbsp;huge&nbsp;pages&nbsp;are&nbsp;somehow&nbsp;causing&nbsp;a&nbsp;different&nbsp;initialization&nbsp;order&nbsp;that&nbsp;avoids&nbsp;a&nbsp;bug&nbsp;in&nbsp;jemalloc,&nbsp;but&nbsp;it's&nbsp;possible&nbsp;that&nbsp;huge&nbsp;pages&nbsp;are&nbsp;erroneously&nbsp;causing&nbsp;the&nbsp;arenas&nbsp;array&nbsp;to&nbsp;be&nbsp;erroneously&nbsp;zeroed&nbsp;after&nbsp;initialization,&nbsp;perhaps&nbsp;due&nbsp;to&nbsp;treating&nbsp;an&nbsp;madvise()&nbsp;on&nbsp;any&nbsp;sub-range&nbsp;as&nbsp;a&nbsp;request&nbsp;to&nbsp;discard&nbsp;the&nbsp;entire&nbsp;huge&nbsp;page.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;Jason&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
