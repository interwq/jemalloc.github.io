<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=us-ascii&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&nbsp;class=&quot;&quot;&gt;On&nbsp;Jan&nbsp;7,&nbsp;2016,&nbsp;at&nbsp;6:46&nbsp;PM,&nbsp;mmzsmm&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:mmzsmm@163.com&quot;&nbsp;class=&quot;&quot;&gt;mmzsmm@163.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;style=&quot;line-height:&nbsp;1.7;&nbsp;font-size:&nbsp;14px;&nbsp;font-family:&nbsp;Arial;&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;[...]&nbsp;according&nbsp;to&nbsp;the&nbsp;code&nbsp;comments,&nbsp;the&nbsp;clean-dirty&nbsp;fragmentation&nbsp;is&nbsp;measured&nbsp;as,&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;*&nbsp;Order&nbsp;such&nbsp;that&nbsp;chunks&nbsp;with&nbsp;higher&nbsp;fragmentation&nbsp;are&nbsp;&quot;less&nbsp;than&quot;&lt;br&nbsp;class=&quot;&quot;&gt;*&nbsp;those&nbsp;with&nbsp;lower&nbsp;fragmentation&nbsp;--&nbsp;purging&nbsp;order&nbsp;is&nbsp;from&nbsp;&quot;least&quot;&nbsp;to&lt;br&nbsp;class=&quot;&quot;&gt;*&nbsp;&quot;greatest&quot;.&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;mean&nbsp;current&nbsp;avail&nbsp;run&nbsp;size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nruns_avail-nruns_adjac&lt;br&nbsp;class=&quot;&quot;&gt;--------------------------------------------&nbsp;&nbsp;=&nbsp;&nbsp;----------------------------------&lt;br&nbsp;class=&quot;&quot;&gt;mean&nbsp;defragmented&nbsp;avail&nbsp;run&nbsp;size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nruns_avail&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;So&nbsp;if&nbsp;I&nbsp;have&nbsp;a&nbsp;chunkA&nbsp;with&nbsp;avail_runs&nbsp;=&nbsp;10,&nbsp;adjac&nbsp;=&nbsp;1,&nbsp;and&nbsp;another&nbsp;chunkB&nbsp;with&nbsp;avail_runs&nbsp;=&nbsp;20,&nbsp;adjac&nbsp;=&nbsp;5.&lt;br&nbsp;class=&quot;&quot;&gt;Obviously,&nbsp;the&nbsp;fragmentA(0.9)&nbsp;&gt;&nbsp;fragmentB(0.75),&nbsp;so&nbsp;the&nbsp;A&nbsp;will&nbsp;be&nbsp;prior&nbsp;to&nbsp;B&nbsp;in&nbsp;the&nbsp;dirty&nbsp;chunk&nbsp;tree,&nbsp;and&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;will&nbsp;be&nbsp;purged&nbsp;first.&nbsp;But&nbsp;the&nbsp;chunkB&nbsp;truely&nbsp;has&nbsp;more&nbsp;adjacs&nbsp;than&nbsp;the&nbsp;A,&nbsp;and&nbsp;the&nbsp;performace&nbsp;gain&nbsp;after&nbsp;purging&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;chunkA&nbsp;is&nbsp;also&nbsp;less&nbsp;than&nbsp;the&nbsp;other(0.1&nbsp;vs&nbsp;0.25).&nbsp;Why&nbsp;we&nbsp;prefer&nbsp;to&nbsp;purge&nbsp;the&nbsp;chunk&nbsp;with&nbsp;&quot;less&nbsp;adjacs&quot;?&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;Shouldn't&nbsp;we&nbsp;purge&nbsp;more&nbsp;adjacs&nbsp;or&nbsp;clean-dirty&nbsp;fragments&nbsp;to&nbsp;acquire&nbsp;more&nbsp;continuous&nbsp;unalloc&nbsp;pages?&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;actually&nbsp;do&nbsp;purge&nbsp;B&nbsp;first,&nbsp;but&nbsp;it's&nbsp;hard&nbsp;to&nbsp;see&nbsp;unless&nbsp;you&nbsp;follow&nbsp;the&nbsp;calculations&nbsp;in&nbsp;the&nbsp;code.&nbsp;&nbsp;Note&nbsp;that&nbsp;a_val=0.45&nbsp;and&nbsp;b_val=1.5&nbsp;in&nbsp;this&nbsp;case,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;comparison&nbsp;function&nbsp;returns&nbsp;1,&nbsp;causing&nbsp;A&nbsp;to&nbsp;come&nbsp;after&nbsp;B&nbsp;in&nbsp;the&nbsp;in-order&nbsp;tree&nbsp;traversal.&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;style=&quot;line-height:&nbsp;1.7;&nbsp;font-size:&nbsp;14px;&nbsp;font-family:&nbsp;Arial;&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Another&nbsp;question&nbsp;is,&nbsp;I&nbsp;notice&nbsp;that&nbsp;before&nbsp;the&nbsp;git&nbsp;node&nbsp;e3d13060&nbsp;there&nbsp;are&nbsp;two&nbsp;avail-trees,&nbsp;one&nbsp;is&nbsp;for&nbsp;dirty,&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;and&nbsp;another&nbsp;for&nbsp;clean,&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;arena_avail_tree_t&nbsp;&nbsp;&nbsp;&nbsp;runs_avail_clean;&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;arena_avail_tree_t&nbsp;&nbsp;&nbsp;&nbsp;runs_avail_dirty;&lt;br&nbsp;class=&quot;&quot;&gt;After&nbsp;that,&nbsp;the&nbsp;two&nbsp;became&nbsp;one.&nbsp;So&nbsp;how&nbsp;to&nbsp;ensure&nbsp;the&nbsp;new&nbsp;runs&nbsp;allocaction&nbsp;to&nbsp;prefer&nbsp;to&nbsp;dirty&nbsp;pages?&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;IIRC,&nbsp;there&nbsp;were&nbsp;versions&nbsp;of&nbsp;jemalloc&nbsp;that&nbsp;did&nbsp;not&nbsp;prefer&nbsp;dirty&nbsp;pages.&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Note&nbsp;that&nbsp;you're&nbsp;looking&nbsp;at&nbsp;jemalloc&nbsp;3.x&nbsp;code,&nbsp;but&nbsp;4.x&nbsp;uses&nbsp;substantially&nbsp;different&nbsp;algorithms&nbsp;that&nbsp;obsoleted&nbsp;the&nbsp;code&nbsp;that&nbsp;ordered&nbsp;chunks&nbsp;according&nbsp;to&nbsp;fragmentation.&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Jason&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
