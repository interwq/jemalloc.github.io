<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Hi&nbsp;folks&lt;br&gt;&lt;br&gt;&lt;/div&gt;I&nbsp;am&nbsp;finding&nbsp;that&nbsp;on&nbsp;freebsd&nbsp;systems&nbsp;using&nbsp;DSS&nbsp;as&nbsp;primary&nbsp;and&nbsp;mmap&nbsp;as&nbsp;secondary&nbsp;way&nbsp;to&nbsp;map&nbsp;pages/chunks,&nbsp;the&nbsp;resident/VM&nbsp;size&nbsp;of&nbsp;process&nbsp;never&nbsp;goes&nbsp;down.&nbsp;This&nbsp;is&nbsp;because&nbsp;chunk_unmap()&nbsp;never&nbsp;does&nbsp;anything&nbsp;to&nbsp;reduce&nbsp;dss_max.&lt;br&gt;&lt;br&gt;&lt;/div&gt;The&nbsp;complete&nbsp;diff&nbsp;below&nbsp;shows&nbsp;a&nbsp;possible&nbsp;way&nbsp;to&nbsp;reduce&nbsp;memory&nbsp;footprint&nbsp;of&nbsp;a&nbsp;running&nbsp;program.&nbsp;Since&nbsp;I&nbsp;am&nbsp;not&nbsp;an&nbsp;active&nbsp;jemalloc&nbsp;coder/contributor,&nbsp;I&nbsp;would&nbsp;request&nbsp;active&nbsp;coders&nbsp;to&nbsp;comment&nbsp;on&nbsp;it&nbsp;and&nbsp;commit&nbsp;it&nbsp;if&nbsp;they&nbsp;find&nbsp;it&nbsp;useful.&lt;br&gt;&lt;br&gt;&lt;/div&gt;These&nbsp;diffs&nbsp;are&nbsp;based&nbsp;off&nbsp;of&nbsp;3.5.0.&lt;br&gt;&lt;/div&gt;&lt;div&gt;test&nbsp;program=&nbsp;starts&nbsp;with&nbsp;a&nbsp;size&nbsp;of&nbsp;1MB,&nbsp;malloc(),&nbsp;then&nbsp;free()&nbsp;and&nbsp;doubles&nbsp;size.&nbsp;then &nbsp;loop&nbsp;10x&nbsp;times.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;SIZE&nbsp;=&nbsp;total&nbsp;size&nbsp;of&nbsp;the&nbsp;test&nbsp;program&nbsp;(text,&nbsp;data&nbsp;and&nbsp;stack)&lt;br&gt;&lt;/div&gt;&lt;div&gt;dss_max&nbsp;=&nbsp;this&nbsp;is&nbsp;the&nbsp;variable&nbsp;in&nbsp;the&nbsp;code&nbsp;used&nbsp;to&nbsp;track&nbsp;max&nbsp;BRK&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;----Before-------                    &nbsp;-----&nbsp;After&nbsp;-----------&lt;br&gt;SIZE   &nbsp;dss_max   &nbsp;              &nbsp;SIZE   &nbsp;dss_max&lt;br&gt;18572K   &nbsp;0x9000000   &nbsp;   &nbsp;18572K   &nbsp;0x9000000&lt;br&gt;26764K   &nbsp;0x9800000   &nbsp;   &nbsp;1384K   &nbsp;0x9400000&lt;br&gt;43148K   &nbsp;0xa800000   &nbsp;   &nbsp;30860K   &nbsp;0x9c00000&lt;br&gt;75916K   &nbsp;0xc800000   &nbsp;   &nbsp;47244K   &nbsp;0xac00000&lt;br&gt;138M   &nbsp;0x10800000   &nbsp;   &nbsp;80012K   &nbsp;0xcc00000&lt;br&gt;266M   &nbsp;0x18800000   &nbsp;   &nbsp;142M   &nbsp;0x10c00000&lt;br&gt;522M   &nbsp;0x28800000   &nbsp;   &nbsp;270M   &nbsp;0x18c00000&lt;br&gt;1034M   &nbsp;0x48800000   &nbsp;   &nbsp;526M   &nbsp;0x28c00000&lt;br&gt;2058M   &nbsp;0x88800000   &nbsp;   &nbsp;1038M   &nbsp;0x48c00000&lt;br&gt;2058M   &nbsp;0x88800000   &nbsp;   &nbsp;14476K   &nbsp;0x8c00000&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;data&nbsp;above&nbsp;shows&nbsp;the&nbsp;VM&nbsp;size&nbsp;of&nbsp;the&nbsp;program&nbsp;shrinking&nbsp;and&nbsp;expanding&nbsp;as&nbsp;the&nbsp;need&nbsp;may&nbsp;be&nbsp;with&nbsp;the&nbsp;fix.&nbsp;This&nbsp;will&nbsp;be&nbsp;very&nbsp;useful&nbsp;for&nbsp;embedded&nbsp;systems&nbsp;which&nbsp;are&nbsp;always&nbsp;tight&nbsp;on&nbsp;memory.&lt;br&gt;&lt;br&gt;&lt;/div&gt;thanks&lt;br&gt;&lt;/div&gt;--sk&lt;br&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;Index:&nbsp;external/bsd/jemalloc/dist/include/jemalloc/internal/chunk_dss.h&lt;br&gt;===================================================================&lt;br&gt;---&nbsp;external/bsd/jemalloc/dist/include/jemalloc/internal/chunk_dss.h   &nbsp;(revision&nbsp;715468)&lt;br&gt;+++&nbsp;external/bsd/jemalloc/dist/include/jemalloc/internal/chunk_dss.h   &nbsp;(working&nbsp;copy)&lt;br&gt;@@&nbsp;-35,6&nbsp;+35,7&nbsp;@@&nbsp;bool &nbsp;chunk_dss_boot(void);&lt;br&gt; void  &nbsp;chunk_dss_prefork(void);&lt;br&gt; void  &nbsp;chunk_dss_postfork_parent(void);&lt;br&gt; void  &nbsp;chunk_dss_postfork_child(void);&lt;br&gt;+bool   &nbsp;chunk_dealloc_dss(void&nbsp;*,&nbsp;size_t);&lt;br&gt;&lt;br&gt; #endif&nbsp;/*&nbsp;JEMALLOC_H_EXTERNS&nbsp;*/&lt;br&gt; /******************************************************************************/&lt;br&gt;Index:&nbsp;external/bsd/jemalloc/dist/src/chunk.c&lt;br&gt;===================================================================&lt;br&gt;---&nbsp;external/bsd/jemalloc/dist/src/chunk.c     &nbsp;(revision&nbsp;715468)&lt;br&gt;+++&nbsp;external/bsd/jemalloc/dist/src/chunk.c     &nbsp;(working&nbsp;copy)&lt;br&gt;@@&nbsp;-305,7&nbsp;+305,7&nbsp;@@&nbsp;chunk_unmap(void&nbsp;*chunk,&nbsp;size_t&nbsp;size)&lt;br&gt;       &nbsp;assert(size&nbsp;!=&nbsp;0);&lt;br&gt;       &nbsp;assert((size&nbsp;&amp;&nbsp;chunksize_mask)&nbsp;==&nbsp;0);&lt;br&gt;&lt;br&gt;-      &nbsp;if&nbsp;(config_dss&nbsp;&amp;&amp;&nbsp;chunk_in_dss(chunk))&lt;br&gt;+      &nbsp;if&nbsp;(config_dss&nbsp;&amp;&amp;&nbsp;chunk_in_dss(chunk)&nbsp;&amp;&amp;&nbsp;chunk_dealloc_dss(chunk,&nbsp;size))&lt;br&gt;               &nbsp;chunk_record(&amp;chunks_szad_dss,&nbsp;&amp;chunks_ad_dss,&nbsp;chunk,&nbsp;size);&lt;br&gt;       &nbsp;else&nbsp;if&nbsp;(chunk_dealloc_mmap(chunk,&nbsp;size))&lt;br&gt;               &nbsp;chunk_record(&amp;chunks_szad_mmap,&nbsp;&amp;chunks_ad_mmap,&nbsp;chunk,&nbsp;size);&lt;br&gt;Index:&nbsp;external/bsd/jemalloc/dist/src/chunk_dss.c&lt;br&gt;===================================================================&lt;br&gt;---&nbsp;external/bsd/jemalloc/dist/src/chunk_dss.c &nbsp;(revision&nbsp;715468)&lt;br&gt;+++&nbsp;external/bsd/jemalloc/dist/src/chunk_dss.c &nbsp;(working&nbsp;copy)&lt;br&gt;@@&nbsp;-139,6&nbsp;+139,28&nbsp;@@&nbsp;chunk_alloc_dss(size_t&nbsp;size,&nbsp;size_t&nbsp;alignment,&nbsp;boo&lt;br&gt; }&lt;br&gt;&lt;br&gt; bool&lt;br&gt;+chunk_dealloc_dss(void&nbsp;*chunk,&nbsp;size_t&nbsp;size)&lt;br&gt;+{&lt;br&gt;+   &nbsp;bool&nbsp;ret;&lt;br&gt;+   &nbsp;int&nbsp;rc;&lt;br&gt;+&lt;br&gt;+   &nbsp;if&nbsp;(config_munmap&nbsp;==&nbsp;false)&nbsp;{&lt;br&gt;+      &nbsp;return&nbsp;true;&lt;br&gt;+   &nbsp;}&lt;br&gt;+&lt;br&gt;+   &nbsp;cassert(config_dss);&lt;br&gt;+   &nbsp;malloc_mutex_lock(&amp;dss_mtx);&lt;br&gt;+   &nbsp;if&nbsp;(((uintptr_t)chunk&nbsp;+&nbsp;(uintptr_t)size)&nbsp;==&nbsp;(uintptr_t)dss_max)&nbsp;{&lt;br&gt;+      &nbsp;int&nbsp;rc;&lt;br&gt;+      &nbsp;rc&nbsp;=&nbsp;brk(chunk);&lt;br&gt;+      &nbsp;dss_max&nbsp;=&nbsp;chunk;&lt;br&gt;+      &nbsp;return(rc&nbsp;!=&nbsp;0);&lt;br&gt;+   &nbsp;}&lt;br&gt;+   &nbsp;malloc_mutex_unlock(&amp;dss_mtx);&lt;br&gt;+   &nbsp;return&nbsp;true;&lt;br&gt;+}&lt;br&gt;+&lt;br&gt;+bool&lt;br&gt; chunk_in_dss(void&nbsp;*chunk)&lt;br&gt; {&lt;br&gt;       &nbsp;bool&nbsp;ret;&lt;br&gt;Index:&nbsp;external/bsd/jemalloc/lib/libjemalloc/include/jemalloc/internal/private_unnamespace.h&lt;br&gt;===================================================================&lt;br&gt;---&nbsp;external/bsd/jemalloc/lib/libjemalloc/include/jemalloc/internal/private_unnamespace.h      &nbsp;(revision&nbsp;715468)&lt;br&gt;+++&nbsp;external/bsd/jemalloc/lib/libjemalloc/include/jemalloc/internal/private_unnamespace.h      &nbsp;(working&nbsp;copy)&lt;br&gt;@@&nbsp;-129,6&nbsp;+129,7&nbsp;@@&lt;br&gt; #undef&nbsp;chunk_dss_prec_set&lt;br&gt; #undef&nbsp;chunk_dss_prefork&lt;br&gt; #undef&nbsp;chunk_in_dss&lt;br&gt;+#undef&nbsp;chunk_dealloc_dss&lt;br&gt; #undef&nbsp;chunk_npages&lt;br&gt; #undef&nbsp;chunk_postfork_child&lt;br&gt; #undef&nbsp;chunk_postfork_parent&lt;br&gt;Index:&nbsp;external/bsd/jemalloc/lib/libjemalloc/include/jemalloc/internal/private_namespace.h&lt;br&gt;===================================================================&lt;br&gt;---&nbsp;external/bsd/jemalloc/lib/libjemalloc/include/jemalloc/internal/private_namespace.h&nbsp;(revision&nbsp;715468)&lt;br&gt;+++&nbsp;external/bsd/jemalloc/lib/libjemalloc/include/jemalloc/internal/private_namespace.h&nbsp;(working&nbsp;copy)&lt;br&gt;@@&nbsp;-129,6&nbsp;+129,7&nbsp;@@&lt;br&gt; #define       &nbsp;chunk_dss_prec_set&nbsp;JEMALLOC_N(chunk_dss_prec_set)&lt;br&gt; #define       &nbsp;chunk_dss_prefork&nbsp;JEMALLOC_N(chunk_dss_prefork)&lt;br&gt; #define       &nbsp;chunk_in_dss&nbsp;JEMALLOC_N(chunk_in_dss)&lt;br&gt;+#define       &nbsp;chunk_dealloc_dss&nbsp;JEMALLOC_N(chunk_dealloc_dss)&lt;br&gt; #define       &nbsp;chunk_npages&nbsp;JEMALLOC_N(chunk_npages)&lt;br&gt; #define       &nbsp;chunk_postfork_child&nbsp;JEMALLOC_N(chunk_postfork_child)&lt;br&gt; #define       &nbsp;chunk_postfork_parent&nbsp;JEMALLOC_N(chunk_postfork_parent)&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;
</tt>
