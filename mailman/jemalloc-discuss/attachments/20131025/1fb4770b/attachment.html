<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Thanks&nbsp;for&nbsp;much.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;need&nbsp;some&nbsp;other&nbsp;wheel.&lt;/div&gt;&lt;div&gt;But,&nbsp;I&nbsp;hope&nbsp;jemalloc&nbsp;handle&nbsp;properly&nbsp;later.&nbsp;:-)&lt;/div&gt;&lt;div&gt;Anyway,&nbsp;thanks&nbsp;again!&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-----&lt;/div&gt;&lt;div&gt;weon&lt;/div&gt;&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2013/10/24&nbsp;Jason&nbsp;Evans&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:jasone@canonware.com&quot;&nbsp;target=&quot;_blank&quot;&gt;jasone@canonware.com&lt;/a&gt;&gt;&lt;/span&gt;&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;On&nbsp;Oct&nbsp;23,&nbsp;2013,&nbsp;at&nbsp;8:11&nbsp;PM,&nbsp;Taehwan&nbsp;Weon&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:taehwan.weon@gmail.com&quot;&gt;taehwan.weon@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;am&nbsp;using&nbsp;jemalloc-3.4.0&nbsp;on&nbsp;Centos&nbsp;6.3&lt;br&gt;<br>
&gt;&nbsp;When&nbsp;my&nbsp;SEGV&nbsp;signal&nbsp;handler&nbsp;tried&nbsp;to&nbsp;dump&nbsp;call&nbsp;stacks,&nbsp;hang&nbsp;occurred&nbsp;as&nbsp;following.&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;don&#39;t&nbsp;know&nbsp;why&nbsp;libc&#39;s&nbsp;fork&nbsp;called&nbsp;jemalloc_prefork&nbsp;even&nbsp;if&nbsp;I&nbsp;didn&#39;t&nbsp;set&nbsp;LD_PRELOAD.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;#0&nbsp; 0x000000351d60d654&nbsp;in&nbsp;__lll_lock_wait&nbsp;()&nbsp;from&nbsp;/lib64/libpthread.so.0&lt;br&gt;<br>
&gt;&nbsp;#1&nbsp; 0x000000351d608f4a&nbsp;in&nbsp;_L_lock_1034&nbsp;()&nbsp;from&nbsp;/lib64/libpthread.so.0&lt;br&gt;<br>
&gt;&nbsp;#2&nbsp; 0x000000351d608e0c&nbsp;in&nbsp;pthread_mutex_lock&nbsp;()&nbsp;from&nbsp;/lib64/libpthread.so.0&lt;br&gt;<br>
&gt;&nbsp;#3&nbsp; 0x00002b59a8055d6d&nbsp;in&nbsp;malloc_mutex_lock&nbsp;(mutex=0x2b59a84a4320)&nbsp;at&nbsp;include/jemalloc/internal/mutex.h:77&lt;br&gt;<br>
&gt;&nbsp;#4&nbsp; malloc_mutex_prefork&nbsp;(mutex=0x2b59a84a4320)&nbsp;at&nbsp;src/mutex.c:109&lt;br&gt;<br>
&gt;&nbsp;#5&nbsp; 0x00002b59a8044c32&nbsp;in&nbsp;arena_prefork&nbsp;(arena=0x2b59a84a3d40)&nbsp;at&nbsp;src/arena.c:2344&lt;br&gt;<br>
&gt;&nbsp;#6&nbsp; 0x00002b59a803f555&nbsp;in&nbsp;jemalloc_prefork&nbsp;()&nbsp;at&nbsp;src/jemalloc.c:1760&lt;br&gt;<br>
&gt;&nbsp;#7&nbsp; 0x000000351ca9a2a6&nbsp;in&nbsp;fork&nbsp;()&nbsp;from&nbsp;/lib64/libc.so.6&lt;br&gt;<br>
&gt;&nbsp;#8&nbsp; 0x000000351ca6200d&nbsp;in&nbsp;_IO_proc_open@@GLIBC_2.2.5&nbsp;()&nbsp;from&nbsp;/lib64/libc.so.6&lt;br&gt;<br>
&gt;&nbsp;#9&nbsp; 0x000000351ca62269&nbsp;in&nbsp;popen@@GLIBC_2.2.5&nbsp;()&nbsp;from&nbsp;/lib64/libc.so.6&lt;br&gt;<br>
&gt;&nbsp;#10&nbsp;0x00002b59a71bc1f9&nbsp;in&nbsp;backtrace_lineinfo&nbsp;(number=1,&nbsp;address=&lt;value&nbsp;optimized&nbsp;out&gt;,&nbsp;symbol=0x2b61f4000918&nbsp;&quot;/usr/lib64/libnc.so.2&nbsp;[0x2b59a71bc3b1]&quot;)&nbsp;at&nbsp;cfs_apix.c:363&lt;br&gt;<br>
&gt;&nbsp;#11&nbsp;0x00002b59a71bc3ff&nbsp;in&nbsp;nc_dump_stack&nbsp;(sig=&lt;value&nbsp;optimized&nbsp;out&gt;)&nbsp;at&nbsp;cfs_apix.c:423&lt;br&gt;<br>
&gt;&nbsp;#12&nbsp;&lt;signal&nbsp;handler&nbsp;called&gt;&lt;br&gt;<br>
&gt;&nbsp;#13&nbsp;0x00002b59a8047332&nbsp;in&nbsp;arena_dalloc_bin_locked&nbsp;(arena=0x2b59a84a3d40,&nbsp;chunk=0x2b61ef000000,&nbsp;ptr=&lt;value&nbsp;optimized&nbsp;out&gt;,&nbsp;mapelm=&lt;value&nbsp;optimized&nbsp;out&gt;)&nbsp;at&nbsp;src/arena.c:1717&lt;br&gt;<br>
&gt;&nbsp;#14&nbsp;0x00002b59a805fba4&nbsp;in&nbsp;tcache_bin_flush_small&nbsp;(tbin=0x2b61ef107128,&nbsp;binind=8,&nbsp;rem=9,&nbsp;tcache=0x2b61ef107000)&nbsp;at&nbsp;src/tcache.c:127&lt;br&gt;<br>
&gt;&nbsp;#15&nbsp;0x00002b59a805fcd4&nbsp;in&nbsp;tcache_event_hard&nbsp;(tcache=0x80)&nbsp;at&nbsp;src/tcache.c:39&lt;br&gt;<br>
&gt;&nbsp;#16&nbsp;0x00002b59a80428d9&nbsp;in&nbsp;tcache_event&nbsp;(ptr=0x2b61efd26dc0)&nbsp;at&nbsp;include/jemalloc/internal/tcache.h:271&lt;br&gt;<br>
&gt;&nbsp;#17&nbsp;tcache_dalloc_small&nbsp;(ptr=0x2b61efd26dc0)&nbsp;at&nbsp;include/jemalloc/internal/tcache.h:408&lt;br&gt;<br>
&gt;&nbsp;#18&nbsp;arena_dalloc&nbsp;(ptr=0x2b61efd26dc0)&nbsp;at&nbsp;include/jemalloc/internal/arena.h:1003&lt;br&gt;<br>
&gt;&nbsp;#19&nbsp;idallocx&nbsp;(ptr=0x2b61efd26dc0)&nbsp;at&nbsp;include/jemalloc/internal/jemalloc_internal.h:913&lt;br&gt;<br>
&gt;&nbsp;#20&nbsp;iqallocx&nbsp;(ptr=0x2b61efd26dc0)&nbsp;at&nbsp;include/jemalloc/internal/jemalloc_internal.h:932&lt;br&gt;<br>
&gt;&nbsp;#21&nbsp;iqalloc&nbsp;(ptr=0x2b61efd26dc0)&nbsp;at&nbsp;include/jemalloc/internal/jemalloc_internal.h:939&lt;br&gt;<br>
&gt;&nbsp;#22&nbsp;jefree&nbsp;(ptr=0x2b61efd26dc0)&nbsp;at&nbsp;src/jemalloc.c:1272&lt;br&gt;<br>
&gt;&nbsp;#23&nbsp;0x00002b59a71c958b&nbsp;in&nbsp;__nc_free&nbsp;(p=0x2b61efd26dd0,&nbsp;file=&lt;value&nbsp;optimized&nbsp;out&gt;,&nbsp;lno=&lt;value&nbsp;optimized&nbsp;out&gt;)&nbsp;at&nbsp;util.c:1916&lt;br&gt;<br>
&gt;&nbsp;#24&nbsp;0x00002b59a71cb975&nbsp;in&nbsp;tlcq_dequeue&nbsp;(q=0x2b59a9ee3210,&nbsp;msec=&lt;value&nbsp;optimized&nbsp;out&gt;)&nbsp;at&nbsp;tlc_queue.c:215&lt;br&gt;<br>
&gt;&nbsp;#25&nbsp;0x00002b59a71c154b&nbsp;in&nbsp;tp_worker&nbsp;(d=&lt;value&nbsp;optimized&nbsp;out&gt;)&nbsp;at&nbsp;threadpool.c:116&lt;br&gt;<br>
&gt;&nbsp;#26&nbsp;0x000000351d60683d&nbsp;in&nbsp;start_thread&nbsp;()&nbsp;from&nbsp;/lib64/libpthread.so.0&lt;br&gt;<br>
&gt;&nbsp;#27&nbsp;0x000000351cad503d&nbsp;in&nbsp;clone&nbsp;()&nbsp;from&nbsp;/lib64/libc.so.6&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Any&nbsp;hint&nbsp;will&nbsp;be&nbsp;highly&nbsp;appreciated.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;jemalloc&nbsp;calls&nbsp;pthread_atfork(3)&nbsp;in&nbsp;order&nbsp;to&nbsp;install&nbsp;functions&nbsp;that&nbsp;get&nbsp;called&nbsp;just&nbsp;before&nbsp;and&nbsp;after&nbsp;fork(2).&nbsp; In&nbsp;this&nbsp;case&nbsp;your&nbsp;application&nbsp;is&nbsp;causing&nbsp;a&nbsp;signal&nbsp;while&nbsp;deep&nbsp;inside&nbsp;jemalloc&nbsp;(very&nbsp;likely&nbsp;due&nbsp;to&nbsp;memory&nbsp;corruption),&nbsp;with&nbsp;locks&nbsp;already&nbsp;acquired.&nbsp; Deadlock&nbsp;obviously&nbsp;results.&nbsp; To&nbsp;my&nbsp;surprise,&nbsp;fork()&nbsp;is&nbsp;actually&nbsp;listed&nbsp;in&nbsp;the&nbsp;signal(7)&nbsp;manual&nbsp;page&nbsp;as&nbsp;an&nbsp;async-signal-safe&nbsp;function,&nbsp;though&nbsp;popen(3)&nbsp;isn&#39;t,&nbsp;and&nbsp;it&nbsp;would&nbsp;probably&nbsp;allocate&nbsp;memory&nbsp;if&nbsp;it&nbsp;got&nbsp;past&nbsp;the&nbsp;hang&nbsp;during&nbsp;fork().&nbsp; If&nbsp;you&nbsp;were&nbsp;to&nbsp;call&nbsp;fork()&nbsp;directly,&nbsp;then&nbsp;you&#39;d&nbsp;be&nbsp;hitting&nbsp;a&nbsp;peculiar&nbsp;failure&nbsp;condition&nbsp;and&nbsp;we&nbsp;could&nbsp;make&nbsp;a&nbsp;case&nbsp;for&nbsp;jemalloc&#39;s&nbsp;behavior&nbsp;being&nbsp;questionable,&nbsp;but&nbsp;as&nbsp;your&nbsp;signal&nbsp;handler&nbsp;is&nbsp;written,&nbsp;it&nbsp;is&nbsp;simply&nbsp;unreliable&nbsp;due&nbsp;to&nbsp;calling&nbsp;something&nbsp;outside&nbsp;the&nbsp;list&nbsp;of&nbsp;async-signal-safe&nbsp;functions.&lt;br&gt;<br>
<br>
&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
Jason&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;p&nbsp;style=&quot;line-height:115%&quot;&gt;&lt;span&nbsp;style=&quot;line-height:115%;font-size:9pt&quot;&gt;&lt;strong&gt;원&nbsp;태환&lt;/strong&gt;ㅣ&lt;/span&gt;&lt;span&nbsp;style=&quot;line-height:115%;font-size:9pt&quot;&gt;&nbsp;부사장/COO&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;&lt;u&gt;&lt;/u&gt;&nbsp;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;(&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:9pt&quot;&gt;주&lt;span&nbsp;lang=&quot;EN-US&quot;&gt;)&lt;/span&gt;솔박스&nbsp;&lt;span&nbsp;lang=&quot;EN-US&quot;&gt;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:9pt&quot;&gt;서울시&nbsp;강남구&nbsp;역삼동&lt;span&nbsp;lang=&quot;EN-US&quot;&gt;&nbsp;747-2&nbsp;&lt;/span&gt;해성빌딩&lt;span&nbsp;lang=&quot;EN-US&quot;&gt;&nbsp;7&lt;/span&gt;층&lt;span&nbsp;lang=&quot;EN-US&quot;&gt;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;&lt;span&nbsp;style=&quot;color:rgb(192,0,0);font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;T&lt;/span&gt;&lt;/b&gt;&lt;span&nbsp;style=&quot;color:rgb(64,64,64);font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;color:rgb(31,73,125);font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;02-2182-3600 &lt;/span&gt;&lt;span&nbsp;style=&quot;color:rgb(31,73,125);font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;   &nbsp;&lt;/span&gt;&lt;b&gt;&lt;span&nbsp;style=&quot;color:rgb(192,0,0);font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;F&lt;/span&gt;&lt;/b&gt;&lt;span&nbsp;style=&quot;color:rgb(64,64,64);font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;02-2058-2651&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;color:rgb(64,64,64);font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;&nbsp;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;b&gt;&lt;span&nbsp;style=&quot;color:rgb(192,0,0);font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;M&lt;/span&gt;&lt;/b&gt;&lt;span&nbsp;style=&quot;color:rgb(64,64,64);font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;010-3335-8258 &nbsp;&lt;/span&gt;&lt;b&gt;&lt;span&nbsp;style=&quot;color:rgb(192,0,0);font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;E&lt;/span&gt;&lt;/b&gt;&lt;span&nbsp;style=&quot;color:rgb(64,64,64);font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:9pt&quot;&nbsp;lang=&quot;EN-US&quot;&gt;&lt;a&nbsp;href=&quot;mailto:weon@solbox.com&quot;&nbsp;target=&quot;_blank&quot;&gt;weon@solbox.com&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;/div&gt;<br>

</tt>
